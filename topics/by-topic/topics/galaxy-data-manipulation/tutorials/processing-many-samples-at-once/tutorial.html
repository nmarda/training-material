<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Collections: Multisample Analysis</title>
        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-45719423-18' , 'auto');
            ga('send', 'pageview');
        </script>
        
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <link rel="stylesheet" href="/training-material/assets/css/font-awesome.css">
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

        
        
        
        
        
        <meta name="description" content="A collection of microtutorials explaining data manipulati..." />
        <meta property="og:title" content="Galaxy Training: Collections: Multisample Analysis" />
        <meta property="og:description" content="A collection of microtutorials explaining data manipulati..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    </head>
    <body data-spy="scroll" data-target="#toc">
        











<header>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/training-material/topics/galaxy-data-manipulation" title="Go back to list of tutorials">
                            <i class="fa fa-folder-o" aria-hidden="true"></i><span class="visually-hidden">topic</span> Data Manipulation
                        </a>
                    </li>

                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="EN">
                            EN
                        </a>
                        <div class="dropdown-menu">
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fgalaxy-data-manipulation%2Ftutorials%2Fprocessing-many-samples-at-once%2Ftutorial.html&edit-text=&act=url" title="">
                                FR
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fgalaxy-data-manipulation%2Ftutorials%2Fprocessing-many-samples-at-once%2Ftutorial.html&edit-text=&act=url" title="">
                                JA
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fgalaxy-data-manipulation%2Ftutorials%2Fprocessing-many-samples-at-once%2Ftutorial.html&edit-text=&act=url" title="">
                                ES
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fgalaxy-data-manipulation%2Ftutorials%2Fprocessing-many-samples-at-once%2Ftutorial.html&edit-text=&act=url" title="">
                                PT
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fgalaxy-data-manipulation%2Ftutorials%2Fprocessing-many-samples-at-once%2Ftutorial.html&edit-text=&act=url" title="">
                                AR
                            </a>
                            
                        </div>
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="fa fa-life-ring" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>

        <div class="dropdown-divider"></div>
        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQ">
            FAQ
        </a>
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Chat on Gitter">
            Chat on Gitter
        </a>
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            Discuss on Galaxy Help
        </a>
    </div>
</li>


                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/master/topics/galaxy-data-manipulation/tutorials/processing-many-samples-at-once/tutorial.md">
                            <i class="fa fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="container main-content">
    <script type="application/ld+json">
        


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Collections: Multisample Analysis",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "license": "/blob//LICENSE.md",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "courseCode": "galaxy-data-manipulation / processing-many-samples-at-once / hands-on",
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Collections: Multisample Analysis' tutorial",
  "isPartOf": {
    "@type": "Course",
    "name": "Collections: Multisample Analysis",
    "description": "Collections: Multisample Analysis",
    "learningResourceType": "tutorial",
    "interactivityType": "expositive",
    "provider": {
      "@type": "Organization",
      "email": "galaxytrainingnetwork@gmail.com",
      "name": "Galaxy Training Network",
      "url": "https://galaxyproject.org/teach/gtn/"
    }
  },
  "url": "https://galaxyproject.github.io//training-material/topics/galaxy-data-manipulation/tutorials/processing-many-samples-at-once/tutorial.html",
  "timeRequired": "PT1H",
  "description": "Collections: Multisample Analysis",
  "hasPart": [

  ],
  "mentions": [
    {
      "@type": "Thing",
      "url": "",
      "name": "Training data for Collections: Multisample Analysis tutorial"
    }
  ],
  "author": [
    {
      "@type": "Person",
      "name": "Anton Nekrutenko"
    },
    {
      "@type": "Person",
      "name": "Anne Pajon"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Anton Nekrutenko"
    },
    {
      "@type": "Person",
      "name": "Anne Pajon"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Data Manipulation",
      "description": "A collection of microtutorials explaining data manipulation within Galaxy",
      "url": "https://galaxyproject.github.io//training-material/topics/galaxy-data-manipulation/"
    },
    {
      "@type": "DefinedTerm",
      "@id": "http://edamontology.org/",
      "inDefinedTermSet": "http://edamontology.org",
      "termCode": "",
      "url": "https://bioportal.bioontology.org/ontologies/EDAM/?p=classes&conceptid=http%3A%2F%2Fedamontology.org%2F"
    }
  ],
  "skillLevel": "Advanced"
}
    </script>

    <section class="tutorial">
        <h1 data-toc-skip>Collections: Multisample Analysis</h1>
        <div class="contributors-line">By: 

<a href="/training-material/hall-of-fame#nekrut" class="contributor-badge"><img src="https://avatars.githubusercontent.com/nekrut" alt="Anton Nekrutenko">Anton Nekrutenko</a>, <a href="/training-material/hall-of-fame#pajanne" class="contributor-badge"><img src="https://avatars.githubusercontent.com/pajanne" alt="Anne Pajon">Anne Pajon</a>

</div>
        <blockquote class="overview">
            <h3>Overview</h3>
            <strong><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Questions</strong>
            <ul>
            
            </ul>

            <strong><i class="fa fa-bullseye" aria-hidden="true"></i><span class="visually-hidden">objectives</span> Objectives</strong>
            <ul>
            
            </ul>

            

            
            <p><strong><i class="fa fa-hourglass-end" aria-hidden="true"></i><span class="visually-hidden">time</span> Time estimation:</strong> 1 hour</p>
            

            
            <p><strong><i class="fa fa-graduation-cap" aria-hidden="true"></i><span class="visually-hidden">level</span> Level: </strong>
             Advanced 
<span class="level advanced" title="Advanced Tutorial">
  <i class="fa fa-graduation-cap" aria-hidden="true"></i><span class="visually-hidden">level</span> <i class="fa fa-graduation-cap" aria-hidden="true"></i><span class="visually-hidden">level</span> <i class="fa fa-graduation-cap" aria-hidden="true"></i><span class="visually-hidden">level</span>
</span>

</p>
            



            <div>
                <div><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials</strong></div>
                <div id="supporting_materials">
                    <ul>
                        <li>
                            <div>
                    

                    

                    
                    


                    
                            </div>
                        </li>
                    </ul>
                </div>

            </div>

        </blockquote>

        <div class="container">
            <div class="row">
                <!-- sidebar, which will move to the top on a small screen -->
                <div class="col-sm-2">
                    <nav id="toc" data-toggle="toc" class="sticky-top"></nav>
                </div>
                <div class="col-sm-10">
                    <blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

  <p>In this tutorial, we will deal with:</p>

<ol id="markdown-toc">
  <li><a href="#processing-many-samples-at-once" id="markdown-toc-processing-many-samples-at-once">Processing many samples at once</a>    <ol>
      <li><a href="#0-getting-data" id="markdown-toc-0-getting-data">0. Getting data</a></li>
      <li><a href="#1-creating-a-list-of-paired-datasets" id="markdown-toc-1-creating-a-list-of-paired-datasets">1. Creating a list of paired datasets</a></li>
      <li><a href="#20-using-collections" id="markdown-toc-20-using-collections">2.0. Using collections</a></li>
      <li><a href="#3-processing-collection-as-a-single-entity" id="markdown-toc-3-processing-collection-as-a-single-entity">3. Processing collection as a single entity</a></li>
      <li><a href="#4-lets-look-at-what-weve-got" id="markdown-toc-4-lets-look-at-what-weve-got">4. Let’s look at what we’ve got!</a></li>
      <li><a href="#5-we-did-not-fake-this" id="markdown-toc-5-we-did-not-fake-this">5. We did not fake this:</a></li>
      <li><a href="#6-if-things-dont-work" id="markdown-toc-6-if-things-dont-work">6. If things don’t work…</a></li>
    </ol>
  </li>
</ol>

</blockquote>

<h1 id="processing-many-samples-at-once">Processing many samples at once</h1>

<p>Here we will show Galaxy features designed to help with the analysis of large numbers of samples. When you have just a few samples - clicking through them is easy. But once you’ve got hundreds - it becomes very annoying. In Galaxy we have introduced <strong>Dataset collections</strong> that allow you to combine numerous datasets in a single entity that can be easily manipulated.</p>

<h4 id="in-this-tutorial-we-assume-the-following">In this tutorial we assume the following:</h4>

<ul>
  <li>you already have basic understanding of how Galaxy works (if you don’t see <a href="https://usegalaxy.org/galaxy101">Galaxy 101</a> tutorial;</li>
  <li>you have an account in Galaxy (<a href="https://github.com/nekrut/galaxy/wiki/Galaxy101-1#01-setting-up-galaxy-account">see this</a> if you don’t);</li>
  <li>you have your browser configured as described <a href="https://github.com/nekrut/galaxy/wiki/Galaxy101-1#00-getting-your-display-sorted-out">here</a>.</li>
</ul>

<p><i class="fa fa-warning" aria-hidden="true"></i><span class="visually-hidden">warning</span> <em>At this time this tutorial is using Galaxy’s test server at https://test.galaxyproject.org. Once the main site is updated this tutorial will be edited.</em></p>

<h2 id="0-getting-data">0. Getting data</h2>
<p><a href="https://test.galaxyproject.org/u/anton/h/collections-1">Here</a> is a history containing a few datasets we will be practicing with (as always with Galaxy tutorial you can upload your own data and play with it instead of the provided datasets):</p>

<ul>
  <li><code class="highlighter-rouge">M117-bl_1</code> - family 117, mother, 1-st (<strong>F</strong>) read from <strong>blood</strong></li>
  <li><code class="highlighter-rouge">M117-bl_2</code> - family 117, mother, 2-nd (<strong>R</strong>) read from <strong>blood</strong></li>
  <li><code class="highlighter-rouge">M117-ch_1</code> - family 117, mother, 1-st (<strong>F</strong>) read from <strong>cheek</strong></li>
  <li><code class="highlighter-rouge">M117-ch_1</code> - family 117, mother, 2-nd (<strong>R</strong>) read from <strong>cheek</strong></li>
  <li><code class="highlighter-rouge">M117C1-bl_1</code>- family 117, child, 1-st (<strong>F</strong>) read from <strong>blood</strong></li>
  <li><code class="highlighter-rouge">M117C1-bl_2</code>- family 117, child, 2-nd (<strong>R</strong>) read from <strong>blood</strong></li>
  <li><code class="highlighter-rouge">M117C1-ch_1</code>- family 117, child, 1-st (<strong>F</strong>) read from <strong>cheek</strong></li>
  <li><code class="highlighter-rouge">M117C1-ch_2</code>- family 117, child, 2-nd (<strong>R</strong>) read from <strong>cheek</strong></li>
</ul>

<p>These datasets represent genomic DNA (enriched for mitochondria via a long range PCR) isolated from blood and cheek (buccal swab) of mother (<code class="highlighter-rouge">M117</code>) and her child (<code class="highlighter-rouge">M117C1</code>) that was sequenced on an Illumina miSeq machine as paired-read library (250-bp reads; see our <a href="http://www.pnas.org/content/111/43/15474.abstract">2014</a> manuscript for <strong>Methods</strong>).</p>

<h2 id="1-creating-a-list-of-paired-datasets">1. Creating a list of paired datasets</h2>

<p>If you imported <a href="https://test.galaxyproject.org/u/anton/h/collections-1">history</a> as described <a href="https://github.com/nekrut/galaxy/wiki/Processing-many-samples-at-once#0-getting-data">above</a>, your screen will look something like this:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/manyDatasets.png" alt="manyDatasets" /></p>

<p>Now click the checkbox in <img src="https://galaxyproject.org/tutorials/collections/historyItemControls.png" alt="HistioryItemControls" /> and you will see your history changing like this:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/historyWithCheckboxes.png" alt="historyWithCheckboxes" /></p>

<p>Let’s click <code class="highlighter-rouge">All</code>, which will select all datasets in the history, then click <img src="https://galaxyproject.org/tutorials/collections/forAllSelected.png" alt="allSelected" /> and finally select <strong>Build List of Dataset Pairs</strong> from the following menu:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/buildPairs.png" alt="buildPairs" /></p>

<p>The following wizard will appear:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/collectionCreation.png" alt="collectionCreation" /></p>

<p>In this case Galaxy automatically assigned pairs using the <code class="highlighter-rouge">_1</code> and <code class="highlighter-rouge">_2</code> endings of dataset names. Let’s however pretend that this did not happen. Click on <strong>Unpair all</strong> (highlighted in red in the figure above) link and then on <strong>Clear</strong> link (highlighted in blue in the figure above). The interface will change into its virgin state:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/collectionCreationClean.png" alt="collectionCreationClean" /></p>

<p>Hopefully you remember that we have paired-end data in this scenario. Datasets containing the first (forward) and the second (reverse) read are differentiated by having <code class="highlighter-rouge">_1</code> and <code class="highlighter-rouge">_2</code> in the filename. We can use this feature in dataset collection wizard to pair our datasets.  Type <code class="highlighter-rouge">_1</code> in the left <strong>Filter this list</strong> text box and <code class="highlighter-rouge">_2</code> in the right:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/1and2.png" alt="1and2" /></p>

<p>You will see that the dataset collection wizard will automatically filter lists on each side of the interface:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/collectionPrefiltered.png" alt="collectionPrefiltered" /></p>

<p>Now you can either click <strong>Auto pair</strong> if pairs look good to you (proper combinations of datasets are listed in each line) or pair each forward/reverse group individually by pressing <strong>Pair these datasets</strong> button separating each pair:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/collectionCreation.png" alt="collectionCreation" /></p>

<p>Now it is time to name the collection:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/collectionNaming.png" alt="collectionNaming" /></p>

<p>and create the collection by clicking <strong>Create list</strong>. A new item will appear in the history as you can see on the panel <strong>A</strong> below. Clicking on collection will expand it to show four pairs it contains (panel <strong>B</strong>). Clicking individual pairs will expand them further to reveal <strong>forward</strong> and <strong>reverse</strong> datasets (panel <strong>C</strong>). Expanding these further will enable one to see individual datasets (panel <strong>D</strong>).</p>

<p><img src="https://galaxyproject.org/tutorials/collections/collection_ABCD.png" alt="collection_ABCD" /></p>

<h2 id="20-using-collections">2.0. Using collections</h2>

<p>By now we see that a collection can be used to bundle a large number of items into a single history item. This means that many Galaxy tools will be able to process all datasets in a collection transparently to you. Let’s try to map these datasets to human genome using <code class="highlighter-rouge">bwa-mem</code> mapper:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/bwa_mem_collection_readGroups.png" alt="bwa_mem_collection_readGroups" /></p>

<p>Here is what you need to do:</p>

<ul>
  <li>set <strong>Using reference genome</strong> to <code class="highlighter-rouge">hg38</code> (red outline);</li>
  <li>set <strong>Single or Paired-end reads</strong> to <code class="highlighter-rouge">Paired collection</code> (blue outline);</li>
  <li>select <code class="highlighter-rouge">M177-collection</code> from <strong>Select a paired collection</strong> dropdown (magenta outline);</li>
  <li>In <strong>Set read groups information</strong> select <code class="highlighter-rouge">Automatically assign ID</code> (green outline);</li>
  <li>scroll down and click <strong>Execute</strong>.</li>
</ul>

<p>You will see jobs being submitted and new datasets appearing in the history. IN particular below you can see that Galaxy has started four jobs (two yellow and two gray). This is because we have eight paired datasets with each pair being processed separately by <code class="highlighter-rouge">bwa-mem</code>. As a result we have four <code class="highlighter-rouge">bwa-mem</code> runs:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/bwa_memCollectionRunning.png" alt="bwa_memCollectionRunning" /></p>

<p>Once these jobs are finished they will disappear from the history and all results will be represented as a new collection:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/bwa_memCollectionDone.png" alt="bwa_memCollectionDone" /></p>

<p>Let’s look at this collection by clicking on it (panel <strong>A</strong> in the figure below). You can see that now this collection is no longer paired (compared to the collection we created in the beginning of this tutorial). This is because <code class="highlighter-rouge">bwa-mem</code> takes forward and reverse data as input, but produces only a single BAM dataset as the output. So what we have in the result is a <em>list</em> of four dataset (BAM files; panels <strong>B</strong> and <strong>C</strong>).</p>

<p><img src="https://galaxyproject.org/tutorials/collections/bwa_memCollection_ABC.png" alt="bwa_memCollection_ABC" /></p>

<h2 id="3-processing-collection-as-a-single-entity">3. Processing collection as a single entity</h2>

<p>Now that <code class="highlighter-rouge">bwa-mem</code> has finished and generated a collection of BAM datasets we can continue to analyze the entire collection as a single Galaxy ‘<em>item</em>’.</p>

<h3 id="30-ensuring-consistency-of-bam-dataset">3.0. Ensuring consistency of BAM dataset</h3>

<p>Let’s perform cleanup of our BAM files with <code class="highlighter-rouge">cleanSam</code> utility from the <strong>Picard</strong> package:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/cleanSam.png" alt="cleanSam" /></p>

<p>If you look at the picture above carefully, you will see that the <strong>Select SAM/BAM dataset or dataset collection</strong> parameter is empty (it says <code class="highlighter-rouge">No sam or bam datasets available.</code>). This is because we do not have single SAM or BAM datasets in the history. Instead we have a collection. So all you need to do is to click on the <strong>folder</strong> (<img src="https://galaxyproject.org/tutorials/collections/folder.png" alt="folder" />) button and you will our BAM collection selected:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/cleanSam_closeup.png" alt="cleanSam_closeup" /></p>

<p>Click <strong>Execute</strong>. As an output this tool will produce a collection contained cleaned data.</p>

<h3 id="31-retaining-proper-pairs">3.1. Retaining ‘proper pairs’</h3>

<p>Now let’s clean the dataset further by only preserving truly paired reads (reads satisfying two requirements: (1) read is paired, and (2) it is mapped as a proper pair). For this we will use <code class="highlighter-rouge">Filter SAM or BAM</code> tools from <strong>SAMTools</strong> collection:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/filter.png" alt="filter" /></p>

<p>parameters should be set as shown below. By setting mapping quality to <code class="highlighter-rouge">20</code> we avoid reads mapping to multiple locations and by using <strong>Filter on bitwise flag</strong> option we ensure that the resulting dataset will contain only properly paired reads. This operation will produce yet another collection containing now filtered datasets.</p>

<p><img src="https://galaxyproject.org/tutorials/collections/filter_closeup.png" alt="filter_closeup" /></p>

<h3 id="32-merging-collection-into-a-single-dataset">3.2. Merging collection into a single dataset</h3>

<p>The beauty of BAM datasets is that they can be combined in a single entity using so called <em>Read group</em> (<a href="https://wiki.galaxyproject.org/Learn/GalaxyNGS101#Understanding_and_manipulating_SAM.2FBAM_datasets">learn more</a> about Read Groups on old wiki, which will be migrated here shortly). This allows to bundle reads from multiple experiments into a single dataset where read identity is maintained by labelling every sequence with <em>read group</em> tags. So let’s finally reduce this collection to a single BAM dataset. For this we will use <code class="highlighter-rouge">MergeSamFiles</code> tool for the <code class="highlighter-rouge">Picard</code> suite:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/merge.png" alt="merge" /></p>

<p>Here we select the collection generated by the filtering tool described above in <a href="https://github.com/nekrut/galaxy/wiki/Processing-many-samples-at-once#31-retaining-proper-pairs">3.1</a>:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/merge_closeup.png" alt="merge_closeup" /></p>

<p>This operation will <strong>not</strong> generate a collection. Instead, it will generate a single BAM dataset containing mapped reads from our four samples (<code class="highlighter-rouge">M117-bl</code>, <code class="highlighter-rouge">M117-ch</code>, <code class="highlighter-rouge">M117C1-bl</code>, and <code class="highlighter-rouge">M117C1-ch</code>).</p>

<h2 id="4-lets-look-at-what-weve-got">4. Let’s look at what we’ve got!</h2>

<p>So we have one BAM dataset combining everything we’ve done so far. Let’s look at the contents of this dataset using a genome browser. First, we will need to downsample the dataset to avoiding overwhelming the browser. For this we will use <code class="highlighter-rouge">Downsample SAM/BAM</code> tool:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/downsample.png" alt="downsample" /></p>

<p>Set <strong>Probability (between 0 and 1) that any given read will be kept</strong> to roughly <code class="highlighter-rouge">5%</code> (or <code class="highlighter-rouge">0.05</code>) using the slider control:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/downsample_closeup.png" alt="downsample_closeup" /></p>

<p>This will generate another BAM dataset containing only 5% of the original reads and much smaller as a result. Click on this dataset and you will see links to various genome browsers:</p>

<p><img src="https://galaxyproject.org/tutorials/collections/browserLinks.png" alt="browserLinks" /></p>

<p>Click the <strong>Human hg38</strong> link in the <strong>display with IGV</strong> line as highlighted above (<a href="https://wiki.galaxyproject.org/Learn/GalaxyNGS101#Visualizing_multiple_datasets_in_Integrated_Genome_Viewer_.28IGV.29">learn</a> more about displaying Galaxy data in IGV with this <a href="https://vimeo.com/123442619#t=4m16s">movie</a>). Below is an example generated with IGV on these data. In this screenshot reads are colored by read group (four distinct colors). A yellow inset displays additional information about a single read. One can see that this read corresponds to read group <code class="highlighter-rouge">M117-bl</code>.</p>

<p><img src="https://galaxyproject.org/tutorials/collections/igv.png" alt="igv" /></p>

<h2 id="5-we-did-not-fake-this">5. We did not fake this:</h2>
<p>The two histories and the workflow described in this page are accessible directly from this page below:</p>

<ul>
  <li>History <a href="https://test.galaxyproject.org/u/anton/h/collections-1"><strong>Collections</strong></a></li>
  <li>History <a href="https://test.galaxyproject.org/u/anton/h/collections-full-analysis"><strong>Collections (full analysis)</strong></a></li>
</ul>

<p>From there you can import histories to make them your own.</p>

<h2 id="6-if-things-dont-work">6. If things don’t work…</h2>
<p>…you need to complain. Use <a href="https://help.galaxyproject.org/">Galaxy’s Help Channel</a> to do this.</p>



                    

                    

                    

                </div>
            </div>
        </div>

        <h3><i class="fa fa-thumbs-up" aria-hidden="true"></i><span class="visually-hidden">congratulations</span> Congratulations on successfully completing this tutorial!</h3>

        

        

        <hr>
        <br>

        <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Collections: Multisample Analysis (Data Manipulation)">Loading...
        </iframe>

        <blockquote class="feedback">
            <h3><i class="fa fa-comments-o" aria-hidden="true"></i><span class="visually-hidden">feedback</span> Give us even more feedback on this content!</h3>
            <p>To give us more detailed feedback about these materials, please take a moment to fill in the extended <a href="https://docs.google.com/forms/d/e/1FAIpQLSc_GLZRpxZGAL9tN6DA1bE6WkNhmQdXT7B16TpOb-X4YwKUsQ/viewform?entry.1548889262=Collections: Multisample Analysis (Data Manipulation)">Feedback Form</a>.</p>
        </blockquote>
    </section>
</div>


<footer>
    <div class="container">
        <p>
            This material is the result of a collaborative work. Thanks to the
            <a href="https://wiki.galaxyproject.org/Teach/GTN">Galaxy Training Network</a>
            and all the <a href="/training-material/hall-of-fame">contributors</a> (Anton Nekrutenko, Anne Pajon)!
        </p>
        <p>
            Found a typo? Something is wrong in this tutorial? Edit it on
            <a href="https://github.com/galaxyproject/training-material/tree/master/topics/galaxy-data-manipulation/tutorials/processing-many-samples-at-once/tutorial.md">GitHub</a>.
        </p>
    </div>
</footer>

    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>

    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
    var snippets=document.querySelectorAll('div.highlight');
    [].forEach.call(snippets,function(snippet){
        snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
    });

    var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.nextElementSibling;
    }});
    </script>
</html>
