<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Connecting Galaxy to a compute cluster</title>
        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-45719423-18' , 'auto');
            ga('send', 'pageview');
        </script>
        
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <link rel="stylesheet" href="/training-material/assets/css/font-awesome.css">
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

        
        
        
        
        
        <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:title" content="Galaxy Training: Connecting Galaxy to a compute cluster" />
        <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    </head>
    <body data-spy="scroll" data-target="#toc">
        











<header>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/training-material/topics/admin" title="Go back to list of tutorials">
                            <i class="fa fa-folder-o" aria-hidden="true"></i><span class="visually-hidden">topic</span> Galaxy Server administration
                        </a>
                    </li>

                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="EN">
                            EN
                        </a>
                        <div class="dropdown-menu">
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fconnect-to-compute-cluster%2Ftutorial.html&edit-text=&act=url" title="">
                                FR
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fconnect-to-compute-cluster%2Ftutorial.html&edit-text=&act=url" title="">
                                JA
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fconnect-to-compute-cluster%2Ftutorial.html&edit-text=&act=url" title="">
                                ES
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fconnect-to-compute-cluster%2Ftutorial.html&edit-text=&act=url" title="">
                                PT
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fconnect-to-compute-cluster%2Ftutorial.html&edit-text=&act=url" title="">
                                AR
                            </a>
                            
                        </div>
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="fa fa-life-ring" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>

        <div class="dropdown-divider"></div>
        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQ">
            FAQ
        </a>
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Chat on Gitter">
            Chat on Gitter
        </a>
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            Discuss on Galaxy Help
        </a>
    </div>
</li>


                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/master/topics/admin/tutorials/connect-to-compute-cluster/tutorial.md">
                            <i class="fa fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="container main-content">
    <script type="application/ld+json">
        


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Connecting Galaxy to a compute cluster",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "license": "/blob//LICENSE.md",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "courseCode": "admin / connect-to-compute-cluster / hands-on",
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Connecting Galaxy to a compute cluster' tutorial",
  "isPartOf": {
    "@type": "Course",
    "name": "Connecting Galaxy to a compute cluster",
    "description": "Connecting Galaxy to a compute cluster",
    "learningResourceType": "tutorial",
    "interactivityType": "expositive",
    "provider": {
      "@type": "Organization",
      "email": "galaxytrainingnetwork@gmail.com",
      "name": "Galaxy Training Network",
      "url": "https://galaxyproject.org/teach/gtn/"
    }
  },
  "url": "https://galaxyproject.github.io//training-material/topics/admin/tutorials/connect-to-compute-cluster/tutorial.html",
  "timeRequired": "PT4H",
  "keywords": "ansible",
  "description": "Connecting Galaxy to a compute cluster\\nThe questions this  addresses are:\n - How to connect Galaxy to a compute cluster?\n - How can I configure job dependent resources, like cores, memory for my DRM?\n\n\\nThe objectives are:\n - Be familiar with the basics of installing, configuring, and using Slurm\n - Understand all components of the Galaxy job running stack\n - Understand how the `job_conf.xml` file controls Galaxy's jobs subsystem\n - Have a strong understanding of Galaxy job destinations\n - Know how to map tools to job destinations\n - Be able to use the dynamic job runner to make arbitrary destination mappings\n - Understand the job resource selector config and dynamic rule creation\n - The various ways in which tools can be mapped to destinations, both statically and dynamically\n - How to write a dynamic tool destination (DTD)\n - How to write a dynamic python function destination\n - How to use the job resource parameter selection feature\n\n",
  "coursePrerequisites": [
    {
      "@type": "Course",
      "url": "https://galaxyproject.github.io//training-material/topics/admin/tutorials/ansible/slides.html",
      "name": "Ansible",
      "description": "Slides for 'Ansible' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://galaxyproject.github.io//training-material/topics/admin/tutorials/ansible/tutorial.html",
      "name": "Ansible",
      "description": "Hands-on for 'Ansible' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://galaxyproject.github.io//training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html",
      "name": "Galaxy Installation with Ansible",
      "description": "Hands-on for 'Galaxy Installation with Ansible' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    }
  ],
  "hasPart": [

  ],
  "mentions": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Björn Grüning"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Björn Grüning"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://galaxyproject.github.io//training-material/topics/admin/"
    }
  ]
}
    </script>

    <section class="tutorial">
        <h1 data-toc-skip>Connecting Galaxy to a compute cluster</h1>
        <div class="contributors-line">By: 

<a href="/training-material/hall-of-fame#natefoo" class="contributor-badge"><img src="https://avatars.githubusercontent.com/natefoo" alt="Nate Coraor">Nate Coraor</a>, <a href="/training-material/hall-of-fame#bgruening" class="contributor-badge"><img src="https://avatars.githubusercontent.com/bgruening" alt="Björn Grüning">Björn Grüning</a>, <a href="/training-material/hall-of-fame#erasche" class="contributor-badge"><img src="https://avatars.githubusercontent.com/erasche" alt="Helena Rasche">Helena Rasche</a>

</div>
        <blockquote class="overview">
            <h3>Overview</h3>
            <strong><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Questions</strong>
            <ul>
            
            <li>How to connect Galaxy to a compute cluster?</li>
            
            <li>How can I configure job dependent resources, like cores, memory for my DRM?</li>
            
            </ul>

            <strong><i class="fa fa-bullseye" aria-hidden="true"></i><span class="visually-hidden">objectives</span> Objectives</strong>
            <ul>
            
            <li>Be familiar with the basics of installing, configuring, and using Slurm</li>
            
            <li>Understand all components of the Galaxy job running stack</li>
            
            <li>Understand how the `job_conf.xml` file controls Galaxy's jobs subsystem</li>
            
            <li>Have a strong understanding of Galaxy job destinations</li>
            
            <li>Know how to map tools to job destinations</li>
            
            <li>Be able to use the dynamic job runner to make arbitrary destination mappings</li>
            
            <li>Understand the job resource selector config and dynamic rule creation</li>
            
            <li>The various ways in which tools can be mapped to destinations, both statically and dynamically</li>
            
            <li>How to write a dynamic tool destination (DTD)</li>
            
            <li>How to write a dynamic python function destination</li>
            
            <li>How to use the job resource parameter selection feature</li>
            
            </ul>

            
            <strong><i class="fa fa-check-circle" aria-hidden="true"></i><span class="visually-hidden">requirements</span> Requirements</strong>
            <ul>
            
            
    <li>
    
        
        
        <a href="/training-material/topics/admin">Galaxy Server administration</a>
        
            <ul>
                
                    
                        
                    
                        
                    
                        
                            
                            <li> Ansible:
                            
                                <a href="/training-material/topics/admin/tutorials/ansible/slides.html"><i class="fa fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/admin/tutorials/ansible/tutorial.html"><i class="fa fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Galaxy Installation with Ansible:
                            
                            
                                
                                     <a href="/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html"><i class="fa fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
            </ul>
        
    
    </li>

            </ul>
            

            
            <p><strong><i class="fa fa-hourglass-end" aria-hidden="true"></i><span class="visually-hidden">time</span> Time estimation:</strong> 4 hours</p>
            

            



            <div>
                <div><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials</strong></div>
                <div id="supporting_materials">
                    <ul>
                        <li>
                            <div>
                    
                    <div>
                        <a class="topic-icon" href="/training-material/topics/admin/tutorials/connect-to-compute-cluster/slides.html" title="Slides for this tutorial">
                            <i class="fa fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> Slides
                        </a>
                    </div>
                    

                    

                    
                    


                    
                    
                    <div>
                        

    <a href="#" class="btn btn-default dropdown-toggle topic-icon" data-toggle="dropdown" aria-expanded="false" title="Where to run the tutorial">
        <i class="fa fa-cog" aria-hidden="true"></i><span class="visually-hidden">instances</span> Galaxies
    </a>
    <ul class="dropdown-menu">
    
        <li>
            <a class="dropdown-item" href="https://github.com/galaxyproject/training-material/tree/master/topics/admin/docker" title="Docker image for this tutorial">
                <i class="fa fa-ship" aria-hidden="true"></i><span class="visually-hidden">docker_image</span> Docker image
            </a>
        </li>
    
    
    </ul>



                    </div>
                    
                    
                            </div>
                        </li>
                    </ul>
                </div>

            </div>

        </blockquote>

        <div class="container">
            <div class="row">
                <!-- sidebar, which will move to the top on a small screen -->
                <div class="col-sm-2">
                    <nav id="toc" data-toggle="toc" class="sticky-top"></nav>
                </div>
                <div class="col-sm-10">
                    <h1 id="running-galaxy-jobs-with-slurm">Running Galaxy Jobs with Slurm</h1>

<blockquote class="comment">
  <h3 id="comment-note-results-may-vary"><i class="fa fa-commenting-o" aria-hidden="true"></i><span class="visually-hidden">comment</span> Note: results may vary</h3>

  <p>Your results may be slightly different from the ones presented in this tutorial
due to differing versions of tools, reference data, external databases, or
because of stochastic processes in the algorithms.</p>

</blockquote>

<p>The tools that are added to Galaxy can have a wide variance in the compute resources that they require and work efficiently on.
To account for this, Galaxy’s job configuration needs to be tuned to run these tools properly. In addition, site-specific variables must
be taken into consideration when choosing where to run jobs and what parameters to run them with.</p>

<blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

<ol id="markdown-toc">
  <li><a href="#running-galaxy-jobs-with-slurm" id="markdown-toc-running-galaxy-jobs-with-slurm">Running Galaxy Jobs with Slurm</a>    <ol>
      <li><a href="#installing-slurm" id="markdown-toc-installing-slurm">Installing Slurm</a></li>
      <li><a href="#using-slurm" id="markdown-toc-using-slurm">Using Slurm</a></li>
      <li><a href="#slurm-drmaa" id="markdown-toc-slurm-drmaa">Slurm-DRMAA</a></li>
    </ol>
  </li>
  <li><a href="#galaxy-and-slurm" id="markdown-toc-galaxy-and-slurm">Galaxy and Slurm</a>    <ol>
      <li><a href="#running-a-job" id="markdown-toc-running-a-job">Running a Job</a></li>
      <li><a href="#further-reading" id="markdown-toc-further-reading">Further Reading</a></li>
    </ol>
  </li>
  <li><a href="#galaxy-and-slurm---statically-mapping-a-job" id="markdown-toc-galaxy-and-slurm---statically-mapping-a-job">Galaxy and Slurm - Statically Mapping a Job</a>    <ol>
      <li><a href="#writing-a-testing-tool" id="markdown-toc-writing-a-testing-tool">Writing a testing tool</a></li>
      <li><a href="#running-with-more-resources" id="markdown-toc-running-with-more-resources">Running with more resources</a></li>
    </ol>
  </li>
  <li><a href="#dynamic-job-destinations" id="markdown-toc-dynamic-job-destinations">Dynamic Job Destinations</a></li>
  <li><a href="#dynamically-map-a-tool-to-a-job-destination" id="markdown-toc-dynamically-map-a-tool-to-a-job-destination">Dynamically map a tool to a job destination</a>    <ol>
      <li><a href="#writing-a-dynamic-tool-destination" id="markdown-toc-writing-a-dynamic-tool-destination">Writing a Dynamic Tool Destination</a></li>
      <li><a href="#testing-the-dtd" id="markdown-toc-testing-the-dtd">Testing the DTD</a></li>
    </ol>
  </li>
  <li><a href="#job-resource-selectors" id="markdown-toc-job-resource-selectors">Job Resource Selectors</a>    <ol>
      <li><a href="#a-dynamic-destination" id="markdown-toc-a-dynamic-destination">A dynamic destination</a></li>
      <li><a href="#further-reading-1" id="markdown-toc-further-reading-1">Further Reading</a></li>
    </ol>
  </li>
</ol>

</blockquote>

<h2 id="installing-slurm">Installing Slurm</h2>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-installing-slurm"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Installing Slurm</h3>

  <ol>
    <li>
      <p>Create and edit a file in your working directory called <code class="highlighter-rouge">requirements.yml</code> and include the following contents:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="s">galaxyproject.repos</span>
<span class="pi">-</span> <span class="s">galaxyproject.slurm</span>
</code></pre></div>      </div>

      <p>The <code class="highlighter-rouge">galaxyproject.repos</code> role adds the <a href="https://depot.galaxyproject.org/yum/">Galaxy Packages for Enterprise Linux (GPEL)</a> repository for RedHat/CentOS, which provides both Slurm and Slurm-DRMAA (neither are available in standard repositories or EPEL). For Ubuntu versions 18.04 or newer, it adds the <a href="https://launchpad.net/~natefoo/+archive/ubuntu/slurm-drmaa">Slurm-DRMAA PPA</a> (Slurm-DRMAA was removed from Debian/Ubuntu in buster/bionic).</p>
    </li>
    <li>
      <p>In the same directory, run <code class="highlighter-rouge">ansible-galaxy install -p roles -r requirements.yml</code>. This will install all of the required modules for this training into the <code class="highlighter-rouge">roles/</code> folder. We choose to install to a folder to give you easy access to look through the different roles when you have questions on their behaviour.</p>
    </li>
    <li>
      <p>Create the hosts file if you have not done so, include a group for <code class="highlighter-rouge">[galaxyservers]</code> with the address of the host where you will install Slurm</p>
    </li>
    <li>
      <p>Create a playbook, <code class="highlighter-rouge">slurm.yml</code> which looks like the following:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">galaxyservers</span>
  <span class="na">become</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">slurm_roles</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">controller'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">exec'</span><span class="pi">]</span>
    <span class="na">slurm_nodes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">localhost</span>
      <span class="na">CPUs</span><span class="pi">:</span> <span class="s">???</span> <span class="c1"># Here you need to figure out how many cores your machine has. (Hint, `htop`)</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">galaxyproject.slurm</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the playbook (<code class="highlighter-rouge">ansible-playbook -i hosts slurm.yml</code>)</p>
    </li>
  </ol>

</blockquote>

<p>Installed with Slurm is MUNGE (MUNGE Uid ‘N Gid Emporium…) which authenticates users between cluster hosts. You would normally need to ensure the same Munge key is distributed across all cluster hosts (in <code class="highlighter-rouge">/etc/munge/munge.key</code>) - A great task for Ansible. However, the installation of the munge package has created a random key for you, and you will not need to distribute this since you’ll run jobs only on a single host.</p>

<p>You can now check that all of the daemons are running with the command <code class="highlighter-rouge">systemctl status munge slurmd slurmctld</code></p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="nb">sudo </span>systemctl status munge slurmd slurmctld
<span class="go">● munge.service - MUNGE authentication service
</span><span class="gp">   Loaded: loaded (/usr/lib/systemd/system/munge.service;</span> enabled<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
<span class="gp">   Active: active (running) since Sa 2019-01-26 22:38:13 CET;</span> 28min ago
<span class="go">     Docs: man:munged(8)
 Main PID: 22930 (munged)
    Tasks: 4
   Memory: 128.0K
   CGroup: /system.slice/munge.service
           └─22930 /usr/sbin/munged

Jan 26 22:38:13 helena-test.novalocal systemd[1]: Starting MUNGE authentication service...
Jan 26 22:38:13 helena-test.novalocal systemd[1]: Started MUNGE authentication service.

● slurmd.service - Slurm node daemon
</span><span class="gp">   Loaded: loaded (/usr/lib/systemd/system/slurmd.service;</span> enabled<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
<span class="gp">   Active: active (running) since Sa 2019-01-26 23:04:21 CET;</span> 2min 25s ago
<span class="gp">  Process: 15051 ExecStart=/usr/sbin/slurmd $</span>SLURMD_OPTIONS <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>0/SUCCESS<span class="o">)</span>
<span class="go"> Main PID: 15054 (slurmd)
    Tasks: 1
   Memory: 628.0K
   CGroup: /system.slice/slurmd.service
           └─15054 /usr/sbin/slurmd

Jan 26 23:04:21 helena-test.novalocal systemd[1]: Starting Slurm node daemon...
Jan 26 23:04:21 helena-test.novalocal systemd[1]: PID file /var/run/slurmd.pid not readable (yet?) after start.
Jan 26 23:04:21 helena-test.novalocal systemd[1]: Started Slurm node daemon.

● slurmctld.service - Slurm controller daemon
</span><span class="gp">   Loaded: loaded (/usr/lib/systemd/system/slurmctld.service;</span> enabled<span class="p">;</span> vendor preset: disabled<span class="o">)</span>
<span class="gp">   Active: active (running) since Sa 2019-01-26 23:04:20 CET;</span> 2min 26s ago
<span class="gp">  Process: 15040 ExecStart=/usr/sbin/slurmctld $</span>SLURMCTLD_OPTIONS <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span>0/SUCCESS<span class="o">)</span>
<span class="go"> Main PID: 15042 (slurmctld)
    Tasks: 7
   Memory: 1.1M
   CGroup: /system.slice/slurmctld.service
           └─15042 /usr/sbin/slurmctld

Jan 26 23:04:20 helena-test.novalocal systemd[1]: Starting Slurm controller daemon...
Jan 26 23:04:20 helena-test.novalocal systemd[1]: PID file /var/run/slurmctld.pid not readable (yet?) after start.
Jan 26 23:04:20 helena-test.novalocal systemd[1]: Started Slurm controller daemon.
</span></code></pre></div></div>

<p>Running the playbook, the Slurm configuration, <code class="highlighter-rouge">/etc/slurm/slurm.conf</code> (or <code class="highlighter-rouge">/etc/slurm-llnl/slurm.conf</code> on Debian-based distributions) was created for you automatically. All of the variables were set by default. If you need to override the configuration yourself, Slurm provides <a href="https://slurm.schedmd.com/configurator.html">an online tool</a> which will help you configure it.</p>

<h2 id="using-slurm">Using Slurm</h2>

<p>You should now be able to see that your Slurm cluster is operational with the <code class="highlighter-rouge">sinfo</code> command. This shows the state of nodes and partitions (synonymous with queues in other DRMs). The “node-oriented view” provided with the <code class="highlighter-rouge">-N</code> flag is particularly useful:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> sinfo
<span class="go">PARTITION AVAIL  TIMELIMIT  NODES  STATE NODELIST
debug*       up   infinite      1   idle localhost
</span><span class="gp">$</span> sinfo <span class="nt">-Nel</span>
<span class="go">Fri Nov  4 16:51:24 2016
NODELIST   NODES PARTITION       STATE CPUS    S:C:T MEMORY TMP_DISK WEIGHT FEATURES REASON
localhost      1    debug*        idle    1    2:1:1      1        0      1   (null) none
</span></code></pre></div></div>

<p>If your node state is not <code class="highlighter-rouge">idle</code>, something has gone wrong. If your node state ends with an asterisk *, the Slurm controller is attempting to contact the Slurm execution daemon but has not yet been successful (the * next to the partition name is normal, it indicates the default partition).</p>

<p>We want to ensure that Slurm is actually able to run jobs. There are two ways this can be done:</p>

<ul>
  <li><code class="highlighter-rouge">srun</code>: Run an interactive job (e.g. a shell, or a specific program with its stdin, stdout, and stderr all connected to your terminal.</li>
  <li><code class="highlighter-rouge">sbatch</code>: Run a batch job, with stdin closed and stdout/stderr redirected to a file.</li>
</ul>

<p>Galaxy runs <code class="highlighter-rouge">sbatch</code> jobs but we can use both <code class="highlighter-rouge">srun</code> and <code class="highlighter-rouge">sbatch</code> to test:</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-running-commands-with-srun"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Running commands with <code class="highlighter-rouge">srun</code></h3>

  <ol>
    <li>
      <p>Use <a href="https://slurm.schedmd.com/srun.html"><code class="highlighter-rouge">srun</code></a> to run the command <code class="highlighter-rouge">uname -a</code></p>

      <blockquote class="question">
        <h3 id="question-question"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>How did the output look?</p>

        <blockquote class="solution">
          <h3 id="solution-solution"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
          <p>Your output may look slightly different:</p>
          <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> srun <span class="nb">uname</span> <span class="nt">-a</span>
<span class="gp">Linux helena-test.novalocal 3.10.0-862.14.4.el7.x86_64 #</span>1 SMP Wed Sep 26 15:12:11 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
</code></pre></div>          </div>
        </blockquote>
      </blockquote>
    </li>
  </ol>
</blockquote>

<p>Although it looks like this command ran as if I had not used <code class="highlighter-rouge">srun</code>, it was in fact routed through Slurm.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-running-commands-with-sbatch"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Running commands with <code class="highlighter-rouge">sbatch</code></h3>

  <ol>
    <li>
      <p>Create a test job script somewhere, such as in <code class="highlighter-rouge">~/sbatch-test.sh</code>. It should be a batch script which runs <code class="highlighter-rouge">uname -a</code>, <code class="highlighter-rouge">uptime</code>, and sleeps for 30 seconds.</p>

      <blockquote class="question">
        <h3 id="question-question-1"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>What does your shell script look like?</p>

        <blockquote class="solution">
          <h3 id="solution-solution-1"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
          <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">uname</span> <span class="nt">-a</span>
<span class="nb">uptime
sleep </span>30
</code></pre></div>          </div>
        </blockquote>
      </blockquote>
    </li>
    <li>
      <p>Make the script executable, <code class="highlighter-rouge">chmod +x ~/sbatch-test.sh</code></p>
    </li>
    <li>
      <p>Use <a href="https://slurm.schedmd.com/sbatch.html"><code class="highlighter-rouge">sbatch</code></a> to submit the job script</p>

      <blockquote class="question">
        <h3 id="question-question-2"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>What command did you run?</p>

        <blockquote class="solution">
          <h3 id="solution-solution-2"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
          <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> sbatch ~/sbatch-test.sh
</code></pre></div>          </div>
        </blockquote>
      </blockquote>
    </li>
    <li>
      <p>Use <a href="https://slurm.schedmd.com/squeue.html"><code class="highlighter-rouge">squeue</code></a> to check the queue</p>

      <blockquote class="question">
        <h3 id="question-question-3"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>What did the output look like?</p>

        <blockquote class="solution">
          <h3 id="solution-solution-3"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
          <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
   3     debug sbatch-t   ubuntu  R       0:22      1 localhost
</span></code></pre></div>          </div>
        </blockquote>
      </blockquote>
    </li>
  </ol>

</blockquote>

<p>If you’ve made it this far, your Slurm installation is working!</p>

<h2 id="slurm-drmaa">Slurm-DRMAA</h2>

<p>Above Slurm in the stack is slurm-drmaa, a library that provides a translational interface from the Slurm API to the generalized DRMAA API in C.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-installing-slurm-drmaa"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Installing Slurm-DRMAA</h3>

  <ol>
    <li>
      <p>Add a <code class="highlighter-rouge">post_task</code> to your playbook to install <code class="highlighter-rouge">slurm-drmaa1</code> (Debian/Ubuntu) or <code class="highlighter-rouge">slurm-drmaa</code> (RedHat/CentOS), and additionally include the <code class="highlighter-rouge">galaxyproject.repos</code> role</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">galaxyservers</span>
  <span class="na">become</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">slurm_roles</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">controller'</span><span class="pi">,</span> <span class="s1">'</span><span class="s">exec'</span><span class="pi">]</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">galaxyproject.repos</span>
    <span class="pi">-</span> <span class="s">galaxyproject.slurm</span>
  <span class="na">post_tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install slurm-drmaa</span>
      <span class="na">package</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">slurm-drmaa1</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the playbook (<code class="highlighter-rouge">ansible-playbook -i hosts slurm.yml</code>)</p>
    </li>
  </ol>

</blockquote>

<p>Moving one level further up the stack, we find DRMAA Python. This is a Galaxy framework <em>conditional dependency</em>. Conditional dependencies are only installed if, during startup, a configuration option is set that requires that dependency. The <code class="highlighter-rouge">galaxyproject.galaxy</code> Ansible role will install these conditional dependencies, automatically.</p>

<h1 id="galaxy-and-slurm">Galaxy and Slurm</h1>

<p>At the top of the stack sits Galaxy. Galaxy must now be configured to use the cluster we’ve just set up. The DRMAA Python documentation (and Galaxy’s own documentation) instruct that you should set the <code class="highlighter-rouge">$DRMAA_LIBRARY_PATH</code> environment variable so that DRMAA Python can find <code class="highlighter-rouge">libdrmaa.so</code> (aka slurm-drmaa). Because Galaxy runs under supervisor, the environment that Galaxy starts under is controlled by the <code class="highlighter-rouge">environment</code> option in <code class="highlighter-rouge">/etc/supervisor/conf.d/galaxy.conf</code>. The galaxy task should thus be updated to refer to the path to slurm-drmaa, which is <code class="highlighter-rouge">/usr/lib/slurm-drmaa/lib/libdrmaa.so.1</code>:</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-making-galaxy-aware-of-drmaa"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Making Galaxy aware of DRMAA</h3>

  <ol>
    <li>
      <p>Open your group variables and edit the supervisor task, update the environment variable:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">supervisor_programs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">galaxy</span>
    <span class="s">...</span>
    <span class="na">configuration</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="no">...</span>
      <span class="no">environment=HOME="{{ galaxy_mutable_data_dir }}",VIRTUAL_ENV="{{ galaxy_venv_dir }}",PATH="{{ galaxy_venv_dir }}/bin:%(ENV_PATH)s",DRMAA_LIBRARY_PATH="/usr/lib/slurm-drmaa/lib/libdrmaa.so.1"</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>We need to modify <code class="highlighter-rouge">job_conf.xml</code> to instruct Galaxy’s job handlers to load the Slurm job runner plugin, and set the Slurm job submission parameters. A job runner plugin definition must have the <code class="highlighter-rouge">id</code>, <code class="highlighter-rouge">type</code>, and <code class="highlighter-rouge">load</code> attributes. The entire <code class="highlighter-rouge">&lt;plugins&gt;</code> tag group should look like:</p>

      <p>If the folder does not exist, create <code class="highlighter-rouge">files/galaxy/config</code> next to your <code class="highlighter-rouge">playbook.yml</code> (<code class="highlighter-rouge">mkdir -p files/galaxy/config/</code>)</p>

      <p>Create <code class="highlighter-rouge">files/galaxy/config/job_conf.xml</code> with the following contents:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;job_conf&gt;</span>
    <span class="nt">&lt;plugins</span> <span class="na">workers=</span><span class="s">"4"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;plugin</span> <span class="na">id=</span><span class="s">"local"</span> <span class="na">type=</span><span class="s">"runner"</span> <span class="na">load=</span><span class="s">"galaxy.jobs.runners.local:LocalJobRunner"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;plugin</span> <span class="na">id=</span><span class="s">"slurm"</span> <span class="na">type=</span><span class="s">"runner"</span> <span class="na">load=</span><span class="s">"galaxy.jobs.runners.slurm:SlurmJobRunner"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;destinations&gt;</span>
        <span class="nt">&lt;destination</span> <span class="na">id=</span><span class="s">"local"</span> <span class="na">runner=</span><span class="s">"local"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/destinations&gt;</span>
<span class="nt">&lt;/job_conf&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Next, we need to add a new destination for the Slurm job runner. This is a basic destination with no parameters, Galaxy will do the equivalent of submitting a job as <code class="highlighter-rouge">sbatch /path/to/job_script.sh</code>. Note that we also need to set a default destination now that more than one destination is defined. In a <code class="highlighter-rouge">&lt;destination&gt;</code> tag, the <code class="highlighter-rouge">id</code> attribute is a unique identifier for that destination and the <code class="highlighter-rouge">runner</code> attribute must match the <code class="highlighter-rouge">id</code> of defined plugin:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;destinations</span> <span class="na">default=</span><span class="s">"slurm"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;destination</span> <span class="na">id=</span><span class="s">"slurm"</span> <span class="na">runner=</span><span class="s">"slurm"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;destination</span> <span class="na">id=</span><span class="s">"local"</span> <span class="na">runner=</span><span class="s">"local"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/destinations&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Inform <code class="highlighter-rouge">galaxyproject.galaxy</code> of where you would like the <code class="highlighter-rouge">job_conf.xml</code> to reside in your group variables:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">galaxy_config</span><span class="pi">:</span>
  <span class="na">galaxy</span><span class="pi">:</span>
    <span class="na">job_config_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">galaxy_config_dir</span><span class="nv"> </span><span class="s">}}/job_conf.xml"</span>
</code></pre></div>      </div>

      <p>And then deploy the new config file using the <code class="highlighter-rouge">galaxy_config_files</code> var in your group vars</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">galaxy_config_files</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">src</span><span class="pi">:</span> <span class="s">files/galaxy/config/job_conf.xml</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">galaxy_config['galaxy']['job_config_file']</span><span class="nv"> </span><span class="s">}}"</span>
</code></pre></div>      </div>

      <p>The variable <code class="highlighter-rouge">galaxy_config_files</code> is an array of hashes, each with <code class="highlighter-rouge">src</code> and <code class="highlighter-rouge">dest</code>, the files from src will be copied to dest on the server. <code class="highlighter-rouge">galaxy_template_files</code> exist to template files out.</p>
    </li>
    <li>
      <p>Run your <em>Galaxy</em> playbook (<code class="highlighter-rouge">ansible-playbook -i hosts playbook.yml</code>)</p>
    </li>
    <li>
      <p>Follow the logs with <code class="highlighter-rouge">supervisorctl tail -f galaxy stderr</code></p>
    </li>
    <li>
      <p>Rerun the playbook. Because we updated the supervisor config, Galaxy will automatically be restarted.</p>
    </li>
  </ol>

</blockquote>

<p>Two sections of the log output are of interest. First, when Galaxy parses <code class="highlighter-rouge">job_conf.xml</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>galaxy.jobs DEBUG 2016-11-05 14:07:12,649 Loading job configuration from /srv/galaxy/config/job_conf.xml
galaxy.jobs DEBUG 2016-11-05 14:07:12,650 Read definition for handler 'handler0'
galaxy.jobs DEBUG 2016-11-05 14:07:12,651 Read definition for handler 'handler1'
galaxy.jobs DEBUG 2016-11-05 14:07:12,652 &lt;handlers&gt; default set to child with id or tag 'handlers'
galaxy.jobs DEBUG 2016-11-05 14:07:12,652 &lt;destinations&gt; default set to child with id or tag 'slurm'
galaxy.jobs DEBUG 2016-11-05 14:07:12,653 Done loading job configuration
</code></pre></div></div>

<p>Second, when Galaxy loads job runner plugins:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>galaxy.jobs.manager DEBUG 2016-11-05 14:07:22,341 Starting job handler
galaxy.jobs INFO 2016-11-05 14:07:22,347 Handler 'handler0' will load all configured runner plugins
galaxy.jobs.runners DEBUG 2016-11-05 14:07:22,355 Starting 4 LocalRunner workers
galaxy.jobs DEBUG 2016-11-05 14:07:22,367 Loaded job runner 'galaxy.jobs.runners.local:LocalJobRunner' as 'local'
pulsar.managers.util.drmaa DEBUG 2016-11-05 14:07:22,434 Initializing DRMAA session from thread MainThread
galaxy.jobs.runners DEBUG 2016-11-05 14:07:22,443 Starting 4 SlurmRunner workers
galaxy.jobs DEBUG 2016-11-05 14:07:22,455 Loaded job runner 'galaxy.jobs.runners.slurm:SlurmJobRunner' as 'slurm'
galaxy.jobs.handler DEBUG 2016-11-05 14:07:22,455 Loaded job runners plugins: slurm:local
</code></pre></div></div>

<h2 id="running-a-job">Running a Job</h2>

<p>You should now be able to run a Galaxy job through Slurm. The simplest way to test is using the upload tool to upload some text.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-testing-a-slurm-job"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Testing a Slurm Job</h3>

  <ol>
    <li>If you’re not still following the log files with <code class="highlighter-rouge">tail</code>, do so now.</li>
    <li>Click the upload button at the top of the tool panel (on the left side of the Galaxy UI).</li>
    <li>In the resulting modal dialog, click the “Paste/Fetch data” button.</li>
    <li>Type some random characters into the text field that has just appeared.</li>
    <li>Click “Start” and then “Close”</li>
  </ol>

</blockquote>

<p>In your <code class="highlighter-rouge">tail</code> terminal window you should see the following messages:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>galaxy.jobs DEBUG 2016-11-05 14:07:22,862 (2) Persisting job destination (destination id: slurm)
galaxy.jobs.runners DEBUG 2016-11-05 14:07:22,958 Job [2] queued (328.180 ms)
galaxy.jobs.handler INFO 2016-11-05 14:07:22,996 (2) Job dispatched
galaxy.tools.deps DEBUG 2016-11-05 14:07:23,621 Building dependency shell command for dependency 'samtools'
  ...
galaxy.tools.deps WARNING 2016-11-05 14:07:23,631 Failed to resolve dependency on 'samtools', ignoring
galaxy.jobs.command_factory INFO 2016-11-05 14:07:23,674 Built script [/srv/galaxy/server/database/jobs/000/2/tool_script.sh] for tool command[python /srv/galaxy/server/tools/data_source/upload.py /srv/galaxy/server /srv/galaxy/server/database/tmp/tmpkiMZKd /srv/galaxy/server/database/tmp/tmpJuSMo5 2:/srv/galaxy/server/database/jobs/000/2/dataset_2_files:/srv/galaxy/server/database/datasets/000/dataset_2.dat]
galaxy.tools.deps DEBUG 2016-11-05 14:07:24,033 Building dependency shell command for dependency 'samtools'
  ...
galaxy.tools.deps WARNING 2016-11-05 14:07:24,038 Failed to resolve dependency on 'samtools', ignoring
galaxy.jobs.runners DEBUG 2016-11-05 14:07:24,052 (2) command is: mkdir -p working; cd working; /srv/galaxy/server/database/jobs/000/2/tool_script.sh; return_code=$?; cd '/srv/galaxy/server/database/jobs/000/2'; python "/srv/galaxy/server/database/jobs/000/2/set_metadata_CALKH0.py" "/srv/galaxy/server/database/tmp/tmpkiMZKd" "/srv/galaxy/server/database/jobs/000/2/working/galaxy.json" "/srv/galaxy/server/database/jobs/000/2/metadata_in_HistoryDatasetAssociation_2_nnti4M,/srv/galaxy/server/database/jobs/000/2/metadata_kwds_HistoryDatasetAssociation_2_sN3gVP,/srv/galaxy/server/database/jobs/000/2/metadata_out_HistoryDatasetAssociation_2_jIhXJJ,/srv/galaxy/server/database/jobs/000/2/metadata_results_HistoryDatasetAssociation_2_v4v_dv,/srv/galaxy/server/database/datasets/000/dataset_2.dat,/srv/galaxy/server/database/jobs/000/2/metadata_override_HistoryDatasetAssociation_2_OQwwTH" 5242880; sh -c "exit $return_code"
galaxy.jobs.runners.drmaa DEBUG 2016-11-05 14:07:24,125 (2) submitting file /srv/galaxy/server/database/jobs/000/2/galaxy_2.sh
galaxy.jobs.runners.drmaa INFO 2016-11-05 14:07:24,172 (2) queued as 7
galaxy.jobs DEBUG 2016-11-05 14:07:24,172 (2) Persisting job destination (destination id: slurm)
galaxy.jobs.runners.drmaa DEBUG 2016-11-05 14:07:24,539 (2/7) state change: job is queued and active
</code></pre></div></div>

<p>At this point the job has been accepted by Slurm and is awaiting scheduling on a node. Once it’s been sent to a node and starts running, Galaxy logs this event:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>galaxy.jobs.runners.drmaa DEBUG 2016-11-05 14:07:25,559 (2/7) state change: job is running
</code></pre></div></div>

<p>Finally, when the job is complete, Galaxy performs its job finalization process:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>galaxy.jobs.runners.drmaa DEBUG 2016-11-05 14:07:30,883 (2/7) state change: job finished normally
galaxy.model.metadata DEBUG 2016-11-05 14:07:31,132 loading metadata from file for: HistoryDatasetAssociation 2
galaxy.jobs INFO 2016-11-05 14:07:31,336 Collecting metrics for Job 2
galaxy.jobs DEBUG 2016-11-05 14:07:31,370 job 2 ended (finish() executed in (411.821 ms))
galaxy.model.metadata DEBUG 2016-11-05 14:07:31,375 Cleaning up external metadata files
</code></pre></div></div>

<p>Note a few useful bits in the output:</p>
<ul>
  <li><code class="highlighter-rouge">Persisting job destination (destination id: slurm)</code>: Galaxy has selected the <code class="highlighter-rouge">slurm</code> destination we defined</li>
  <li><code class="highlighter-rouge">submitting file /srv/galaxy/server/database/jobs/000/2/galaxy_2.sh</code>: This is the path to the script that is submitted to Slurm as it would be with <code class="highlighter-rouge">sbatch</code></li>
  <li><code class="highlighter-rouge">(2) queued as 7</code>: Galaxy job id “2” is Slurm job id “7”.</li>
  <li>If <code class="highlighter-rouge">job &lt;id&gt; ended</code> is reached, the job should show as done in the UI</li>
</ul>

<p>Slurm allows us to query the exit state of jobs for a time period of the value of Slurm’s <code class="highlighter-rouge">MinJobAge</code> option, which defaults to 300 (seconds, == 5 minutes):</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> scontrol show job 7
<span class="go">JobId=7 JobName=g2_upload1_anonymous_10_0_2_2
   UserId=galaxy(999) GroupId=galaxy(999)
   Priority=4294901754 Nice=0 Account=(null) QOS=(null)
   JobState=COMPLETED Reason=None Dependency=(null)
   Requeue=1 Restarts=0 BatchFlag=1 Reboot=0 ExitCode=0:0
   RunTime=00:00:06 TimeLimit=UNLIMITED TimeMin=N/A
   SubmitTime=2016-11-05T14:07:24 EligibleTime=2016-11-05T14:07:24
   StartTime=2016-11-05T14:07:24 EndTime=2016-11-05T14:07:30
   PreemptTime=None SuspendTime=None SecsPreSuspend=0
   Partition=debug AllocNode:Sid=gat2016:16025
   ReqNodeList=(null) ExcNodeList=(null)
   NodeList=localhost
   BatchHost=localhost
   NumNodes=1 NumCPUs=1 CPUs/Task=1 ReqB:S:C:T=0:0:*:*
   TRES=cpu=1,node=1
   Socks/Node=* NtasksPerN:B:S:C=0:0:*:* CoreSpec=*
   MinCPUsNode=1 MinMemoryNode=0 MinTmpDiskNode=0
   Features=(null) Gres=(null) Reservation=(null)
   Shared=0 Contiguous=0 Licenses=(null) Network=(null)
   Command=(null)
   WorkDir=/srv/galaxy/server/database/jobs/000/2
   StdErr=/srv/galaxy/server/database/jobs/000/2/galaxy_2.e
   StdIn=StdIn=/dev/null
   StdOut=/srv/galaxy/server/database/jobs/000/2/galaxy_2.o
   Power= SICP=0
</span></code></pre></div></div>

<p>After the job has been purged from the active jobs database, a bit of information (but not as much as <code class="highlighter-rouge">scontrol</code> provides) can be retrieved from Slurm’s logs. However, it’s a good idea to set up Slurm’s accounting database to keep old job information in a queryable format.</p>

<h2 id="further-reading">Further Reading</h2>

<ul>
  <li><a href="https://docs.galaxyproject.org/en/latest/admin/cluster.html">Galaxy’s cluster documentation</a> describes in detail alternative cluster configurations.</li>
  <li><a href="https://docs.galaxyproject.org/en/latest/admin/jobs.html">The job_conf.xml documentation</a> fully describes the syntax of the job configuration file.</li>
  <li>The <a href="https://www.drmaa.org/">Distributed Resource Management Application API (DRMAA)</a> page contains the DRMAA specification as well as documentation for various implementations. It also includes a list of DRMs supporting DRMAA.</li>
  <li>The <a href="http://slurm.schedmd.com/">Slurm documentation</a> is extensive and covers all the features and myriad of ways in which you can configure slurm.</li>
  <li><a href="http://apps.man.poznan.pl/trac/slurm-drmaa">PSNC slurm-drmaa</a>’s page includes documentation and the SVN repository, which has a few minor fixes since the last released version. PSNC also wrote the initial implementations of the DRMAA libraries for PBSPro and LSF, so all three are similar.</li>
  <li><a href="http://github.com/natefoo/slurm-drmaa">Our own fork of slurm-drmaa</a> includes support for Slurms <code class="highlighter-rouge">-M</code>/<code class="highlighter-rouge">--clusters</code> multi-cluster functionality.</li>
  <li><a href="http://slurm.schedmd.com/accounting.html">Slurm Accounting documentation</a> explains how to set up SlurmDBD.</li>
</ul>

<h1 id="galaxy-and-slurm---statically-mapping-a-job">Galaxy and Slurm - Statically Mapping a Job</h1>

<p>We don’t want to overload our training VMs trying to run real tools, so to demonstrate how to map a multicore tool to a multicore destination, we’ll create a fake tool.</p>

<h2 id="writing-a-testing-tool">Writing a testing tool</h2>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-deploying-a-tool"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Deploying a Tool</h3>

  <ol>
    <li>
      <p>Create the directory <code class="highlighter-rouge">files/galaxy/tools/</code> if it doesn’t exist and edit a new file in <code class="highlighter-rouge">files/galaxy/tools/testing.xml</code> with the following contents:</p>

      <div class="language-xml question highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;tool</span> <span class="na">id=</span><span class="s">"testing"</span> <span class="na">name=</span><span class="s">"Multicore Tool"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;command&gt;</span>
        <span class="cp">&lt;![CDATA[echo "Running with '\${GALAXY_SLOTS:-1}' threads" &gt; "$output1"]]&gt;</span>
    <span class="nt">&lt;/command&gt;</span>
    <span class="nt">&lt;inputs&gt;</span>
        <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"input1"</span> <span class="na">type=</span><span class="s">"data"</span> <span class="na">format=</span><span class="s">"txt"</span> <span class="na">label=</span><span class="s">"Input Dataset"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/inputs&gt;</span>
    <span class="nt">&lt;outputs&gt;</span>
        <span class="nt">&lt;data</span> <span class="na">name=</span><span class="s">"output1"</span> <span class="na">format=</span><span class="s">"txt"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/outputs&gt;</span>
<span class="nt">&lt;/tool&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Add the tool to the Ansible automated tool conf, <code class="highlighter-rouge">galaxy_local_tools</code></p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">galaxy_local_tools</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">testing.xml</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the playbook</p>
    </li>
    <li>
      <p>Reload Galaxy in your browser and the new tool should now appear in the tool panel. If you have not already created a dataset in your history, upload a random text dataset. Once you have a dataset, click the tool’s name in the tool panel, then click Execute.</p>

      <blockquote class="question">
        <h3 id="question-question-4"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>What is the tool’s output?</p>

        <blockquote class="solution">
          <h3 id="solution-solution-4"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Running with '1' threads
</code></pre></div>          </div>

        </blockquote>

      </blockquote>
    </li>
  </ol>
</blockquote>

<p>Of course, this tool doesn’t actually <em>use</em> the allocated number of cores. In a real tool, you would call the tools’s underlying command with whatever flag that tool provides to control the number of threads or processes it starts, such as <code class="highlighter-rouge">samtools sort -@ \${GALAXY_SLOTS:-1}</code>.</p>

<h2 id="running-with-more-resources">Running with more resources</h2>

<p>We want our tool to run with more than one core. To do this, we need to instruct Slurm to allocate more cores for this job. This is done in the job configuration file.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-allocating-more-resources"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Allocating more resources</h3>

  <ol>
    <li>
      <p>Edit your <code class="highlighter-rouge">files/galaxy/config/job_conf.xml</code> and add the following destination:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;destination</span> <span class="na">id=</span><span class="s">"slurm-2c"</span> <span class="na">runner=</span><span class="s">"slurm"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"nativeSpecification"</span><span class="nt">&gt;</span>--nodes=1 --ntasks=2<span class="nt">&lt;/param&gt;</span>
<span class="nt">&lt;/destination&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Then, map the new tool to the new destination using the tool ID (<code class="highlighter-rouge">&lt;tool id="testing"&gt;</code>) and destination id (<code class="highlighter-rouge">&lt;destination id="slurm-2c"&gt;</code>) by adding a new section to the job config, <code class="highlighter-rouge">&lt;tools&gt;</code>:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;tools&gt;</span>
        <span class="nt">&lt;tool</span> <span class="na">id=</span><span class="s">"testing"</span> <span class="na">destination=</span><span class="s">"slurm-2c"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/tools&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the playbook, and restart Galaxy with <code class="highlighter-rouge">sudo supervisorctl restart all</code>.</p>
    </li>
    <li>
      <p>Click the rerun button on the last history item, or click <strong>Testing Tool</strong> in the tool panel, and then click the tool’s Execute button.</p>

      <blockquote class="question">
        <h3 id="question-question-5"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>What is the tool’s output?</p>

        <blockquote class="solution">
          <h3 id="solution-solution-5"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Running with '2' threads
</code></pre></div>          </div>

        </blockquote>

      </blockquote>
    </li>
  </ol>

</blockquote>

<h1 id="dynamic-job-destinations">Dynamic Job Destinations</h1>

<p>Dynamic destinations allow you to write custom python code to dispatch jobs based on whatever rules you like. For example, UseGalaxy.eu at one point used a very complex custom dispatching configuration to handle sorting jobs between multiple clusters. Galaxy has <a href="https://docs.galaxyproject.org/en/latest/admin/jobs.html#dynamic-destination-mapping-python-method">extensive documentation</a> on how to write these sort of destinations.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-writing-a-dynamic-job-destination"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Writing a dynamic job destination</h3>

  <ol>
    <li>
      <p>Create and open <code class="highlighter-rouge">files/galaxy/dynamic_job_rules/my_rules.py</code></p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">galaxy.jobs</span> <span class="kn">import</span> <span class="n">JobDestination</span>
<span class="kn">from</span> <span class="nn">galaxy.jobs.mapper</span> <span class="kn">import</span> <span class="n">JobMappingException</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">admin_only</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">user_email</span><span class="p">):</span>
    <span class="c1"># Only allow the tool to be executed if the user is an admin
</span>    <span class="n">admin_users</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="s">"admin_users"</span><span class="p">,</span> <span class="s">""</span> <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span> <span class="s">","</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">user_email</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">admin_users</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">JobMappingException</span><span class="p">(</span><span class="s">"Unauthorized."</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">JobDestination</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="s">"slurm"</span><span class="p">)</span>
</code></pre></div>      </div>

      <p>This destination will check that the <code class="highlighter-rouge">user_email</code> is in the set of <code class="highlighter-rouge">admin_users</code> from your config file.</p>
    </li>
    <li>
      <p>As usual, we need to instruct Galaxy of where to find this file:</p>

      <ul>
        <li>
          <p>Edit your group variables file and add the following:</p>

          <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">galaxy_dynamic_job_rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">my_rules.py</span>
</code></pre></div>          </div>
        </li>
      </ul>
    </li>
    <li>
      <p>We next need to configure this plugin in our job configuration:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;destination</span> <span class="na">id=</span><span class="s">"dynamic_admin_only"</span> <span class="na">runner=</span><span class="s">"dynamic"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"type"</span><span class="nt">&gt;</span>python<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"function"</span><span class="nt">&gt;</span>admin_only<span class="nt">&lt;/param&gt;</span>
<span class="nt">&lt;/destination&gt;</span>
</code></pre></div>      </div>

      <p>This is a <strong>Python function dynamic destination</strong>. Galaxy will load all python files in the <code class="highlighter-rouge">{{ galaxy_dynamic_rule_dir }}</code>, and all functions defined in those will be available <code class="highlighter-rouge">my_rules.py</code> to be used in the <code class="highlighter-rouge">job_conf.xml</code></p>
    </li>
    <li>
      <p>Finally, in <code class="highlighter-rouge">job_conf.xml</code>, update the <code class="highlighter-rouge">&lt;tool&gt;</code> definition and point it to this destination:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;tools&gt;</span>
    <span class="nt">&lt;tool</span> <span class="na">id=</span><span class="s">"testing"</span> <span class="na">destination=</span><span class="s">"dynamic_admin_only"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/tools&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the playbook / restart Galaxy</p>
    </li>
  </ol>

</blockquote>

<p>Try running the tool as both an admin user and a non-admin user, non-admins should not be able to run it. You can imagine extending this to complex logic for permissions, or for destination mapping depending on numerous factors. We did not cover it, but in the documentation you can add additional variables to your function signature, and they will be automatically supplied. Some useful variables are <code class="highlighter-rouge">tool</code>, <code class="highlighter-rouge">user</code>, <code class="highlighter-rouge">job</code>, and <code class="highlighter-rouge">app</code> if you need to load configuration information.</p>

<h1 id="dynamically-map-a-tool-to-a-job-destination">Dynamically map a tool to a job destination</h1>

<p>If you don’t want to write dynamic destinations yourself, Dynamic Tool Destinations (DTDs) utilize the dynamic job runner to provide dynamic job mapping functionality without having to explicitly write code to perform the mapping. The mapping functionality is mostly limited to input sizes, but often input size is the most important factor in deciding what resources to allocate for a job.</p>

<h2 id="writing-a-dynamic-tool-destination">Writing a Dynamic Tool Destination</h2>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-writing-a-dtd"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Writing a DTD</h3>

  <ol>
    <li>
      <p>Dynamic tool destinations are configured via a YAML file. As before, we’ll use a fake example but this is extremely useful in real-life scenarios. Create the file <code class="highlighter-rouge">files/galaxy/config/tool_destinations.yml</code> with the following contents:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">tools</span><span class="pi">:</span>
  <span class="na">testing</span><span class="pi">:</span>
    <span class="na">rules</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">rule_type</span><span class="pi">:</span> <span class="s">file_size</span>
        <span class="na">lower_bound</span><span class="pi">:</span> <span class="s">16</span>
        <span class="na">upper_bound</span><span class="pi">:</span> <span class="s">Infinity</span>
        <span class="na">destination</span><span class="pi">:</span> <span class="s">slurm-2c</span>
    <span class="na">default_destination</span><span class="pi">:</span> <span class="s">slurm</span>
<span class="na">default_destination</span><span class="pi">:</span> <span class="s">local</span>
<span class="na">verbose</span><span class="pi">:</span> <span class="s">True</span>
</code></pre></div>      </div>

      <p>The rule says:</p>
      <ul>
        <li>If the tool has ID <code class="highlighter-rouge">testing</code>:
          <ul>
            <li>If the input dataset is &gt;=16 bytes, run on the destination <code class="highlighter-rouge">slurm-2c</code></li>
            <li>If the input dataset is &lt;16 bytes, run on the destination <code class="highlighter-rouge">slurm</code></li>
          </ul>
        </li>
        <li>Else, run on the destination <code class="highlighter-rouge">local</code></li>
      </ul>
    </li>
    <li>
      <p>We also need to inform Galaxy of the path to the file we’ve just created, which is done using the <code class="highlighter-rouge">tool_destinations_config_file</code> in <code class="highlighter-rouge">galaxy_config</code> &gt; <code class="highlighter-rouge">galaxy</code>. Additionally we need to add a <code class="highlighter-rouge">galaxy_config_files</code> entry to ensure it is deployed.</p>

      <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">galaxy_config</span><span class="pi">:</span>
  <span class="na">galaxy</span><span class="pi">:</span>
    <span class="na">tool_destinations_config_file</span><span class="pi">:</span> <span class="pi">{{</span> <span class="nv">galaxy_config_dir</span> <span class="pi">}}</span><span class="s">/tool_destinations.yml</span>
<span class="nn">...</span>
<span class="na">galaxy_config_files</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">- src</span><span class="pi">:</span> <span class="s">files/galaxy/config/tool_destinations.yml</span>
      <span class="s">dest</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">galaxy_config['galaxy']['tool_destinations_config_file']</span><span class="nv"> </span><span class="s">}}"</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>We need to update Galaxy’s job configuration to use this rule. Open <code class="highlighter-rouge">files/galaxy/config/job_conf.xml</code> and add a DTD destination:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;destination</span> <span class="na">id=</span><span class="s">"dtd"</span> <span class="na">runner=</span><span class="s">"dynamic"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"type"</span><span class="nt">&gt;</span>dtd<span class="nt">&lt;/param&gt;</span>
<span class="nt">&lt;/destination&gt;</span>
</code></pre></div>      </div>

      <p>Also, comment out the previous <code class="highlighter-rouge">&lt;tool&gt;</code> definition for the <code class="highlighter-rouge">testing</code> tool, and replace it with a mapping to the dtd destination like so:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;tools&gt;</span>
<span class="c">&lt;!--
    &lt;tool id="testing" destination="slurm-2c"/&gt;
    &lt;tool id="testing" destination="dynamic_admin_only" /&gt;
--&gt;</span>
    <span class="nt">&lt;tool</span> <span class="na">id=</span><span class="s">"testing"</span> <span class="na">destination=</span><span class="s">"dtd"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/tools&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the playbook and restart Galaxy</p>
    </li>
  </ol>

</blockquote>

<h2 id="testing-the-dtd">Testing the DTD</h2>

<p>Our rule specified that any invocation of the <code class="highlighter-rouge">testing</code> tool with an input dataset with size &lt;16 bytes would run on the 1 core destination, whereas any with &gt;= 16 bytes would run on the 2 core destination.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-testing-the-dtd"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Testing the DTD</h3>

  <ol>
    <li>
      <p>Create a dataset using the upload paste tool with a few (&lt;16) characters</p>
    </li>
    <li>
      <p>Create a dataset using the upload paste tool with &gt;16 characters</p>
    </li>
    <li>
      <p>Run the <code class="highlighter-rouge">Testing Tool</code> on both datasets.</p>
    </li>
  </ol>

</blockquote>

<p>You can imagine using this to run large blast jobs on compute hardware with more resources, or giving them more CPU cores. Some tools require more memory as job inputs increase, you can use this to run tools with a larger memory limit, if you know it will need it to process a certain size of inputs.</p>

<h1 id="job-resource-selectors">Job Resource Selectors</h1>

<p>You may find that certain tools can benefit from having form elements added to them to allow for controlling certain job parameters, so that users can select based on their own knowledge. For example, a user might know that a particular set of parameters and inputs to a certain tool needs a larger memory allocation than the standard amount for a given tool. This of course assumes that your users are well behaved enough not to choose the maximum whenever available, although such concerns can be mitigated somewhat by the use of concurrency limits on larger memory destinations.</p>

<p>Such form elements can be added to tools without modifying each tool’s configuration file through the use of the <strong>job resource parameters configuration file</strong></p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-configuring-a-resource-selector"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Configuring a Resource Selector</h3>

  <ol>
    <li>
      <p>Create and open <code class="highlighter-rouge">files/galaxy/config/job_resource_params_conf.xml</code></p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;parameters&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">label=</span><span class="s">"Cores"</span> <span class="na">name=</span><span class="s">"cores"</span> <span class="na">type=</span><span class="s">"select"</span> <span class="na">help=</span><span class="s">"Number of cores to run job on."</span><span class="nt">&gt;</span>
        <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">"1"</span><span class="nt">&gt;</span>1 (default)<span class="nt">&lt;/option&gt;</span>
        <span class="nt">&lt;option</span> <span class="na">value=</span><span class="s">"2"</span><span class="nt">&gt;</span>2<span class="nt">&lt;/option&gt;</span>
    <span class="nt">&lt;/param&gt;</span>
  <span class="nt">&lt;param</span> <span class="na">label=</span><span class="s">"Time"</span> <span class="na">name=</span><span class="s">"time"</span> <span class="na">type=</span><span class="s">"integer"</span> <span class="na">size=</span><span class="s">"3"</span> <span class="na">min=</span><span class="s">"1"</span> <span class="na">max=</span><span class="s">"24"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="na">help=</span><span class="s">"Maximum job time in hours, 'walltime' value (1-24). Leave blank to use default value."</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/parameters&gt;</span>
</code></pre></div>      </div>

      <p>This defines two resource fields, a select box where users can choose between 1 and 2 cores, and a text entry field where users can input an integer value from 1-24 to set the walltime for a job.</p>
    </li>
    <li>
      <p>As usual, we need to instruct Galaxy of where to find this file:</p>

      <ul>
        <li>
          <p>Edit your group variables file and add the following:</p>

          <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">galaxy_config</span><span class="pi">:</span>
  <span class="na">galaxy</span><span class="pi">:</span>
    <span class="na">job_resource_params_file</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">galaxy_config_dir</span><span class="nv"> </span><span class="s">}}/job_resource_params_conf.xml"</span>
<span class="nn">...</span>
<span class="na">galaxy_config_files</span><span class="pi">:</span>
  <span class="s">...</span>
  <span class="s">- src</span><span class="pi">:</span> <span class="s">files/galaxy/config/job_resource_params_conf.xml</span>
    <span class="s">dest</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">galaxy_config['galaxy']['job_resource_params_file']</span><span class="nv"> </span><span class="s">}}"</span>
</code></pre></div>          </div>
        </li>
      </ul>
    </li>
    <li>
      <p>Next, we define a new section in <code class="highlighter-rouge">job_conf.xml</code>: <code class="highlighter-rouge">&lt;resources&gt;</code>. This groups together parameters that should appear together on a tool form. Add the following section to your <code class="highlighter-rouge">files/galaxy/config/job_conf.xml</code>:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;resources&gt;</span>
    <span class="nt">&lt;group</span> <span class="na">id=</span><span class="s">"testing"</span><span class="nt">&gt;</span>cores,time<span class="nt">&lt;/group&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div>      </div>

      <p>The group ID will be used to map a tool to job resource parameters, and the text value of the <code class="highlighter-rouge">&lt;group&gt;</code> tag is a comma-separated list of <code class="highlighter-rouge">name</code>s from <code class="highlighter-rouge">job_resource_params_conf.xml</code> to include on the form of any tool that is mapped to the defined <code class="highlighter-rouge">&lt;group&gt;</code>.</p>
    </li>
    <li>
      <p>Finally, in <code class="highlighter-rouge">job_conf.xml</code>, move the previous <code class="highlighter-rouge">&lt;tool&gt;</code> definition for the <code class="highlighter-rouge">testing</code> tool into the comment and define a new <code class="highlighter-rouge">&lt;tool&gt;</code> that defines the <code class="highlighter-rouge">resources</code> for the tool:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;tools&gt;</span>
    <span class="c">&lt;!--
    &lt;tool id="testing" destination="slurm-2c"/&gt;
    &lt;tool id="testing" destination="dtd"/&gt;
    --&gt;</span>
    <span class="nt">&lt;tool</span> <span class="na">id=</span><span class="s">"testing"</span> <span class="na">destination=</span><span class="s">"dynamic_cores_time"</span> <span class="na">resources=</span><span class="s">"testing_resources"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/tools&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>We have assigned the <code class="highlighter-rouge">testing</code> tool to a new destination: <code class="highlighter-rouge">dynamic_cores_time</code>, but this destination does not exist. We need to create it. Add the following destination in your job conf:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;destination</span> <span class="na">id=</span><span class="s">"dynamic_cores_time"</span> <span class="na">runner=</span><span class="s">"dynamic"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"type"</span><span class="nt">&gt;</span>python<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"function"</span><span class="nt">&gt;</span>dynamic_cores_time<span class="nt">&lt;/param&gt;</span>
<span class="nt">&lt;/destination&gt;</span>
</code></pre></div>      </div>

      <p>This will be another dynamic destination. Galaxy will load all python files in the <code class="highlighter-rouge">{{ galaxy_dynamic_rule_dir }}</code>, and all functions defined in those will be available <code class="highlighter-rouge">dynamic_cores_time</code> to be used in the <code class="highlighter-rouge">job_conf.xml</code></p>
    </li>
  </ol>

</blockquote>

<p>This will set everything up to use the function. We have:</p>

<ul>
  <li>A set of “job resources” defined which will let the user select the number of cores and walltime.</li>
  <li>A job configuration which says:
    <ul>
      <li>that our testing tool should allow selection of the cores and time parameters</li>
      <li>directs it to use a new, <code class="highlighter-rouge">dynamic_cores_time</code> destination</li>
      <li>and a has a new destination, <code class="highlighter-rouge">dynamic_cores_time</code>, which is defined as a dynamic destination which will call a python function we will load.</li>
    </ul>
  </li>
</ul>

<p>This is a lot but we’re still missing the last piece for it to work:</p>

<h2 id="a-dynamic-destination">A dynamic destination</h2>

<p>Lastly, we need to write the rule that will read the value of the job resource parameter form fields and decide how to submit the job.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-writing-a-dynamic-destination"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Writing a dynamic destination</h3>

  <ol>
    <li>
      <p>Create and edit <code class="highlighter-rouge">files/galaxy/dynamic_job_rules/map_resources.py</code>. Create it with the following contents:</p>

      <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">galaxy.jobs.mapper</span> <span class="kn">import</span> <span class="n">JobMappingException</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">DESTINATION_IDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span> <span class="p">:</span> <span class="s">'slurm'</span><span class="p">,</span>
    <span class="mi">2</span> <span class="p">:</span> <span class="s">'slurm-2c'</span>
<span class="p">}</span>
<span class="n">FAILURE_MESSAGE</span> <span class="o">=</span> <span class="s">'This tool could not be run because of a misconfiguration in the Galaxy job running system, please report this error'</span>


<span class="k">def</span> <span class="nf">dynamic_cores_time</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">tool</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">user_email</span><span class="p">):</span>
    <span class="n">destination</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">destination_id</span> <span class="o">=</span> <span class="s">'slurm'</span>

    <span class="c1"># build the param dictionary
</span>    <span class="n">param_dict</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get_param_values</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c1"># handle job resource parameters
</span>    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># validate params
</span>        <span class="n">cores</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s">'__job_resource'</span><span class="p">][</span><span class="s">'cores'</span><span class="p">])</span>
        <span class="n">time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param_dict</span><span class="p">[</span><span class="s">'__job_resource'</span><span class="p">][</span><span class="s">'time'</span><span class="p">])</span>
        <span class="n">destination_id</span> <span class="o">=</span> <span class="n">DESTINATION_IDS</span><span class="p">[</span><span class="n">cores</span><span class="p">]</span>
        <span class="n">destination</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">job_config</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">destination_id</span><span class="p">)</span>
        <span class="c1"># set walltime
</span>        <span class="k">if</span> <span class="s">'nativeSpecification'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">destination</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'nativeSpecification'</span><span class="p">]</span> <span class="o">=</span> <span class="s">''</span>
        <span class="n">destination</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s">'nativeSpecification'</span><span class="p">]</span> <span class="o">+=</span> <span class="s">' --time=</span><span class="si">%</span><span class="s">s:00:00'</span> <span class="o">%</span> <span class="n">time</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># resource param selector not sent with tool form, job_conf.xml misconfigured
</span>        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">'(</span><span class="si">%</span><span class="s">s) error, keys were: </span><span class="si">%</span><span class="s">s'</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="nb">id</span><span class="p">,</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">raise</span> <span class="n">JobMappingException</span><span class="p">(</span><span class="n">FAILURE_MESSAGE</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">'returning destination: </span><span class="si">%</span><span class="s">s'</span><span class="p">,</span> <span class="n">destination_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">destination</span> <span class="ow">or</span> <span class="n">destination_id</span>
</code></pre></div>      </div>

      <p>It is important to note that <strong>you are responsible for parameter validation, including the job resource selector</strong>. This function only handles the job resource parameter fields, but it could do many other things - examine inputs, job queues, other tool parameters, etc.</p>
    </li>
    <li>
      <p>As usual, we need to instruct Galaxy of where to find this file:</p>

      <ul>
        <li>
          <p>Edit your group variables file and add the following:</p>

          <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">galaxy_dynamic_job_rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">my_rules.py</span>
  <span class="pi">-</span> <span class="s">map_resources.py</span>
</code></pre></div>          </div>
        </li>
      </ul>
    </li>
    <li>
      <p>Run the playbook, restart Galaxy</p>
    </li>
    <li>
      <p>Run the <strong>Multicore Tool</strong> with various resource parameter selections</p>

      <ul>
        <li>Use default job resource parameters</li>
        <li>Specify job resource parameters:
          <ul>
            <li>1 core</li>
            <li>2 cores</li>
            <li>Some value for walltime from 1-24</li>
          </ul>
        </li>
      </ul>
    </li>
  </ol>

</blockquote>

<p>The cores parameter can be verified from the output of the tool. The walltime can be verified with <code class="highlighter-rouge">scontrol</code>:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> scontrol show job 24
<span class="go">JobId=24 JobName=g24_multi_anonymous_10_0_2_2
   UserId=galaxy(999) GroupId=galaxy(999)
   Priority=4294901747 Nice=0 Account=(null) QOS=(null)
   JobState=COMPLETED Reason=None Dependency=(null)
   Requeue=1 Restarts=0 BatchFlag=1 Reboot=0 ExitCode=0:0
   RunTime=00:00:05 TimeLimit=12:00:00 TimeMin=N/A
   SubmitTime=2016-11-05T22:01:09 EligibleTime=2016-11-05T22:01:09
   StartTime=2016-11-05T22:01:09 EndTime=2016-11-05T22:01:14
   PreemptTime=None SuspendTime=None SecsPreSuspend=0
   Partition=debug AllocNode:Sid=gat2016:1860
   ReqNodeList=(null) ExcNodeList=(null)
   NodeList=localhost
   BatchHost=localhost
   NumNodes=1 NumCPUs=1 CPUs/Task=1 ReqB:S:C:T=0:0:*:*
   TRES=cpu=1,node=1
   Socks/Node=* NtasksPerN:B:S:C=0:0:*:* CoreSpec=*
   MinCPUsNode=1 MinMemoryNode=0 MinTmpDiskNode=0
   Features=(null) Gres=(null) Reservation=(null)
   Shared=OK Contiguous=0 Licenses=(null) Network=(null)
   Command=(null)
   WorkDir=/srv/galaxy/server/database/jobs/000/24
   StdErr=/srv/galaxy/server/database/jobs/000/24/galaxy_24.e
   StdIn=StdIn=/dev/null
   StdOut=/srv/galaxy/server/database/jobs/000/24/galaxy_24.o
   Power= SICP=0
</span></code></pre></div></div>

<p>Note that the <code class="highlighter-rouge">TimeLimit</code> for this job (which I gave a 12 hour time limit) was set to <code class="highlighter-rouge">12:00:00</code>.</p>

<h2 id="further-reading-1">Further Reading</h2>

<ul>
  <li>The <a href="https://github.com/galaxyproject/galaxy/blob/dev/config/tool_destinations.yml.sample">sample dynamic tool destination config file</a> fully describes the configuration language</li>
  <li><a href="https://docs.galaxyproject.org/en/latest/admin/jobs.html">Dynamic destination documentation</a></li>
  <li>Job resource parameters are not as well documented as they could be, but the <a href="https://github.com/galaxyproject/usegalaxy-playbook/blob/master/env/test/files/galaxy/config/job_resource_params_conf.xml">sample configuration file</a> shows some of the possibilities.</li>
  <li><a href="https://github.com/galaxyproject/usegalaxy-playbook/blob/master/env/main/templates/galaxy/config/job_conf.xml.j2">usegalaxy.org’s job_conf.xml</a> is publicly available for reference.</li>
</ul>



                    
                    <blockquote class="key_points">
                        <h3><i class="fa fa-key" aria-hidden="true"></i><span class="visually-hidden">keypoints</span> Key points</h3>

                        <ul>
                            
                            <li>Galaxy supports a variety of different DRMs.</li>
                            
                            <li>Dynamic Tool Destinations are a convenient way to map</li>
                            
                            <li>Job resource parameters can allow you to give your users control over job resource requirements, if they are knowledgeable about the tools and compute resources available to them.</li>
                            
                        </ul>
                    </blockquote>
                    

                    

                    

                </div>
            </div>
        </div>

        <h3><i class="fa fa-thumbs-up" aria-hidden="true"></i><span class="visually-hidden">congratulations</span> Congratulations on successfully completing this tutorial!</h3>

        

        

        <hr>
        <br>

        <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Connecting Galaxy to a compute cluster (Galaxy Server administration)">Loading...
        </iframe>

        <blockquote class="feedback">
            <h3><i class="fa fa-comments-o" aria-hidden="true"></i><span class="visually-hidden">feedback</span> Give us even more feedback on this content!</h3>
            <p>To give us more detailed feedback about these materials, please take a moment to fill in the extended <a href="https://docs.google.com/forms/d/e/1FAIpQLSc_GLZRpxZGAL9tN6DA1bE6WkNhmQdXT7B16TpOb-X4YwKUsQ/viewform?entry.1548889262=Connecting Galaxy to a compute cluster (Galaxy Server administration)">Feedback Form</a>.</p>
        </blockquote>
    </section>
</div>


<footer>
    <div class="container">
        <p>
            This material is the result of a collaborative work. Thanks to the
            <a href="https://wiki.galaxyproject.org/Teach/GTN">Galaxy Training Network</a>
            and all the <a href="/training-material/hall-of-fame">contributors</a> (Nate Coraor, Björn Grüning, Helena Rasche)!
        </p>
        <p>
            Found a typo? Something is wrong in this tutorial? Edit it on
            <a href="https://github.com/galaxyproject/training-material/tree/master/topics/admin/tutorials/connect-to-compute-cluster/tutorial.md">GitHub</a>.
        </p>
    </div>
</footer>

    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>

    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
    var snippets=document.querySelectorAll('div.highlight');
    [].forEach.call(snippets,function(snippet){
        snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
    });

    var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.nextElementSibling;
    }});
    </script>
</html>
