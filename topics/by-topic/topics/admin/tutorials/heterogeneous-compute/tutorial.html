<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Running Jobs on Remote Resources with Pulsar</title>
        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-45719423-18' , 'auto');
            ga('send', 'pageview');
        </script>
        
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <link rel="stylesheet" href="/training-material/assets/css/font-awesome.css">
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

        
        
        
        
        
        <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:title" content="Galaxy Training: Running Jobs on Remote Resources with Pulsar" />
        <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    </head>
    <body data-spy="scroll" data-target="#toc">
        











<header>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/training-material/topics/admin" title="Go back to list of tutorials">
                            <i class="fa fa-folder-o" aria-hidden="true"></i><span class="visually-hidden">topic</span> Galaxy Server administration
                        </a>
                    </li>

                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="EN">
                            EN
                        </a>
                        <div class="dropdown-menu">
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fheterogeneous-compute%2Ftutorial.html&edit-text=&act=url" title="">
                                FR
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fheterogeneous-compute%2Ftutorial.html&edit-text=&act=url" title="">
                                JA
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fheterogeneous-compute%2Ftutorial.html&edit-text=&act=url" title="">
                                ES
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fheterogeneous-compute%2Ftutorial.html&edit-text=&act=url" title="">
                                PT
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fheterogeneous-compute%2Ftutorial.html&edit-text=&act=url" title="">
                                AR
                            </a>
                            
                        </div>
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="fa fa-life-ring" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>

        <div class="dropdown-divider"></div>
        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQ">
            FAQ
        </a>
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Chat on Gitter">
            Chat on Gitter
        </a>
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            Discuss on Galaxy Help
        </a>
    </div>
</li>


                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/master/topics/admin/tutorials/heterogeneous-compute/tutorial.md">
                            <i class="fa fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="container main-content">
    <script type="application/ld+json">
        


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Running Jobs on Remote Resources with Pulsar",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "license": "/blob//LICENSE.md",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "courseCode": "admin / heterogeneous-compute / hands-on",
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Running Jobs on Remote Resources with Pulsar' tutorial",
  "isPartOf": {
    "@type": "Course",
    "name": "Running Jobs on Remote Resources with Pulsar",
    "description": "Running Jobs on Remote Resources with Pulsar",
    "learningResourceType": "tutorial",
    "interactivityType": "expositive",
    "provider": {
      "@type": "Organization",
      "email": "galaxytrainingnetwork@gmail.com",
      "name": "Galaxy Training Network",
      "url": "https://galaxyproject.org/teach/gtn/"
    }
  },
  "url": "https://galaxyproject.github.io//training-material/topics/admin/tutorials/heterogeneous-compute/tutorial.html",
  "timeRequired": "PT60M",
  "keywords": "ansible",
  "description": "Running Jobs on Remote Resources with Pulsar\\nThe questions this  addresses are:\n - How does pulsar work?\n - How can I deploy it?\n\n\\nThe objectives are:\n - Have an understanding of what Pulsar is and how it works\n - Install and configure a Pulsar server on a remote linux machine\n - Be able to get Galaxy to send jobs to a remote Pulsar server\n\n",
  "coursePrerequisites": [
    {
      "@type": "Course",
      "url": "https://galaxyproject.github.io//training-material/topics/admin/tutorials/ansible/slides.html",
      "name": "Ansible",
      "description": "Slides for 'Ansible' tutorial",
      "learningResourceType": "slides",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://galaxyproject.github.io//training-material/topics/admin/tutorials/ansible/tutorial.html",
      "name": "Ansible",
      "description": "Hands-on for 'Ansible' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    {
      "@type": "Course",
      "url": "https://galaxyproject.github.io//training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html",
      "name": "Galaxy Installation with Ansible",
      "description": "Hands-on for 'Galaxy Installation with Ansible' tutorial",
      "learningResourceType": "hands-on tutorial",
      "interactivityType": "expositive",
      "provider": {
        "@type": "Organization",
        "email": "galaxytrainingnetwork@gmail.com",
        "name": "Galaxy Training Network",
        "url": "https://galaxyproject.org/teach/gtn/"
      }
    },
    "A server/VM on which to deploy Pulsar"
  ],
  "hasPart": [

  ],
  "mentions": [

  ],
  "author": [
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Simon Gladman"
    },
    {
      "@type": "Person",
      "name": "Marius van den Beek"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Nate Coraor"
    },
    {
      "@type": "Person",
      "name": "Simon Gladman"
    },
    {
      "@type": "Person",
      "name": "Marius van den Beek"
    },
    {
      "@type": "Person",
      "name": "Helena Rasche"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://galaxyproject.github.io//training-material/topics/admin/"
    }
  ]
}
    </script>

    <section class="tutorial">
        <h1 data-toc-skip>Running Jobs on Remote Resources with Pulsar</h1>
        <div class="contributors-line">By: 

<a href="/training-material/hall-of-fame#natefoo" class="contributor-badge"><img src="https://avatars.githubusercontent.com/natefoo" alt="Nate Coraor">Nate Coraor</a>, <a href="/training-material/hall-of-fame#slugger70" class="contributor-badge"><img src="https://avatars.githubusercontent.com/slugger70" alt="Simon Gladman">Simon Gladman</a>, <a href="/training-material/hall-of-fame#mvdbeek" class="contributor-badge"><img src="https://avatars.githubusercontent.com/mvdbeek" alt="Marius van den Beek">Marius van den Beek</a>, <a href="/training-material/hall-of-fame#erasche" class="contributor-badge"><img src="https://avatars.githubusercontent.com/erasche" alt="Helena Rasche">Helena Rasche</a>

</div>
        <blockquote class="overview">
            <h3>Overview</h3>
            <strong><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Questions</strong>
            <ul>
            
            <li>How does pulsar work?</li>
            
            <li>How can I deploy it?</li>
            
            </ul>

            <strong><i class="fa fa-bullseye" aria-hidden="true"></i><span class="visually-hidden">objectives</span> Objectives</strong>
            <ul>
            
            <li>Have an understanding of what Pulsar is and how it works</li>
            
            <li>Install and configure a Pulsar server on a remote linux machine</li>
            
            <li>Be able to get Galaxy to send jobs to a remote Pulsar server</li>
            
            </ul>

            
            <strong><i class="fa fa-check-circle" aria-hidden="true"></i><span class="visually-hidden">requirements</span> Requirements</strong>
            <ul>
            
            
    <li>
    
        
        
        <a href="/training-material/topics/admin">Galaxy Server administration</a>
        
            <ul>
                
                    
                        
                    
                        
                    
                        
                            
                            <li> Ansible:
                            
                                <a href="/training-material/topics/admin/tutorials/ansible/slides.html"><i class="fa fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> slides</a>
                                
                            
                            
                                
                                    - <a href="/training-material/topics/admin/tutorials/ansible/tutorial.html"><i class="fa fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            <li> Galaxy Installation with Ansible:
                            
                            
                                
                                     <a href="/training-material/topics/admin/tutorials/ansible-galaxy/tutorial.html"><i class="fa fa-laptop" aria-hidden="true"></i><span class="visually-hidden">tutorial</span> hands-on</a>
                                
                            
                            </li>
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                
            </ul>
        
    
    </li>

    <li>
    
        A server/VM on which to deploy Pulsar
    
    </li>

            </ul>
            

            
            <p><strong><i class="fa fa-hourglass-end" aria-hidden="true"></i><span class="visually-hidden">time</span> Time estimation:</strong> 60 minutes</p>
            

            



            <div>
                <div><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials</strong></div>
                <div id="supporting_materials">
                    <ul>
                        <li>
                            <div>
                    
                    <div>
                        <a class="topic-icon" href="/training-material/topics/admin/slides/introduction.html" title="Introduction slides">
                            <i class="fa fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> Introduction Slides
                        </a>
                    </div>
                    

                    

                    
                    


                    
                    
                    <div>
                        

    <a href="#" class="btn btn-default dropdown-toggle topic-icon" data-toggle="dropdown" aria-expanded="false" title="Where to run the tutorial">
        <i class="fa fa-cog" aria-hidden="true"></i><span class="visually-hidden">instances</span> Galaxies
    </a>
    <ul class="dropdown-menu">
    
        <li>
            <a class="dropdown-item" href="https://github.com/galaxyproject/training-material/tree/master/topics/admin/docker" title="Docker image for this tutorial">
                <i class="fa fa-ship" aria-hidden="true"></i><span class="visually-hidden">docker_image</span> Docker image
            </a>
        </li>
    
    
    </ul>



                    </div>
                    
                    
                            </div>
                        </li>
                    </ul>
                </div>

            </div>

        </blockquote>

        <div class="container">
            <div class="row">
                <!-- sidebar, which will move to the top on a small screen -->
                <div class="col-sm-2">
                    <nav id="toc" data-toggle="toc" class="sticky-top"></nav>
                </div>
                <div class="col-sm-10">
                    <h1 class="no_toc" id="overview">Overview</h1>

<p>Pulsar is the Galaxy Project’s remote job running system. It was written by John Chilton (@jmchilton) of the Galaxy Project. It is a python server application that can accept jobs from a Galaxy server, submit them to a local resource and then send the results back to the originating Galaxy server.</p>

<p>More details on Pulsar can be found at:</p>

<ul>
  <li><a href="https://pulsar.readthedocs.io/en/latest/index.html">Pulsar’s Documentation</a></li>
  <li><a href="https://github.com/galaxyproject/pulsar">Pulsar’s Github Repository</a></li>
  <li><a href="https://github.com/galaxyproject/ansible-pulsar">Pulsar Ansible Role</a></li>
</ul>

<p>Transport of data, tool information and other metadata can be configured as a web application via a RESTful interface or using a message passing system such as RabbitMQ.</p>

<p>At the Galaxy end, it is configured within the <code class="highlighter-rouge">job_conf.xml</code> file and uses one of two special Galaxy job runners.</p>
<ul>
  <li><code class="highlighter-rouge">galaxy.jobs.runners.pulsar:PulsarRESTJobRunner</code> for the RESTful interface</li>
  <li><code class="highlighter-rouge">galaxy.jobs.runners.pulsar:PulsarMQJobRunner</code> for the message passing interface.</li>
</ul>

<p>In this tutorial, we will:</p>

<ul>
  <li>Install and configure a Pulsar server on a remote linux machine using ansible
    <ul>
      <li>We will configure the Pulsar server to run via the RESTful interface</li>
    </ul>
  </li>
  <li>Configure our Galaxy servers to run a job there</li>
  <li>Run a job remotely</li>
</ul>

<blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

<ol id="markdown-toc">
  <li><a href="#installing-the-pulsar-role" id="markdown-toc-installing-the-pulsar-role">Installing the Pulsar Role</a></li>
  <li><a href="#configuring-pulsar" id="markdown-toc-configuring-pulsar">Configuring Pulsar</a></li>
  <li><a href="#configuring-galaxy" id="markdown-toc-configuring-galaxy">Configuring Galaxy</a></li>
  <li><a href="#testing-pulsar" id="markdown-toc-testing-pulsar">Testing Pulsar</a></li>
</ol>

</blockquote>

<p>This tutorial assumes that you have:</p>

<ul>
  <li>A VM or machine where you will install Pulsar, and a directory in which the installation will be done. This tutorial assumes it is <code class="highlighter-rouge">/mnt</code></li>
</ul>

<h1 id="installing-the-pulsar-role">Installing the Pulsar Role</h1>

<p>We need to create a new ansible playbook to install Pulsar. We will be using a <em>role</em> written by Nate Coraor - <code class="highlighter-rouge">galaxyproject.pulsar</code></p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-install-the-galaxyprojectpulsar-ansible-role"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Install the <code class="highlighter-rouge">galaxyproject.pulsar</code> ansible role</h3>

  <ol>
    <li>
      <p>From your ansible working directory, edit the <code class="highlighter-rouge">requirements.yml</code> file and add the following line:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="s">galaxyproject.pulsar</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Now install it with:</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-galaxy <span class="nb">install</span> <span class="nt">-p</span> roles <span class="nt">-r</span> requirements.yml
</code></pre></div>      </div>
    </li>
  </ol>

</blockquote>

<h1 id="configuring-pulsar">Configuring Pulsar</h1>

<p>From the <a href="https://github.com/galaxyproject/ansible-pulsar#role-variables"><code class="highlighter-rouge">galaxyproject.pulsar</code> ansible role documentation</a>, we need to specify some variables.</p>

<p>There is one required variable:</p>

<p><code class="highlighter-rouge">pulsar_server_dir</code> - The location in which to install pulsar</p>

<p>Then there are a lot of optional variables. They are listed here for information. We will set some for this tutorial but not all.</p>

<table>
  <thead>
    <tr>
      <th>Variable Name</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">pulsar_pip_install</code></td>
      <td>Set to <code class="highlighter-rouge">true</code> to get pulsar to be sourced from pip.</td>
      <td><code class="highlighter-rouge">false</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">pulsar_yaml_config</code></td>
      <td>a YAML dictionary whose contents will be used to create Pulsar’s <code class="highlighter-rouge">app.yml</code></td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">pulsar_git_repo</code></td>
      <td>Upstream git repository from which Pulsar should be cloned.</td>
      <td>https://github.com/galaxyproject/pulsar</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">pulsar_changeset_id</code></td>
      <td>A changeset id, tag, branch, or other valid git identifier for which version of Pulsar to load</td>
      <td><code class="highlighter-rouge">master</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">pulsar_venv_dir</code></td>
      <td>The role will create a virtualenv from which Pulsar will run</td>
      <td><code class="highlighter-rouge">&lt;pulsar_server_dir&gt;/venv</code> if installing via pip, <code class="highlighter-rouge">&lt;pulsar_server_dir&gt;/.venv</code> if not.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">pulsar_config_dir</code></td>
      <td>Directory that will be used for Pulsar configuration files.</td>
      <td><code class="highlighter-rouge">&lt;pulsar_server_dir&gt;/config</code> if installing via pip, <code class="highlighter-rouge">&lt;pulsar_server_dir&gt;</code> if not</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">pulsar_optional_dependencies</code></td>
      <td>List of optional dependency modules to install, depending on which features you are enabling.</td>
      <td><code class="highlighter-rouge">None</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">pulsar_install_environments</code></td>
      <td>Installing dependencies may require setting certain environment variables to compile successfully.</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>Additional options from Pulsar’s server.ini are configurable via the following variables (these options are explained in the Pulsar documentation and server.ini.sample):</p>

<table>
  <thead>
    <tr>
      <th>Variable</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">pulsar_host</code></td>
      <td>This is the interface pulsar will listen to, we will set it to <code class="highlighter-rouge">0.0.0.0</code></td>
      <td>localhost</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">pulsar_port</code></td>
      <td> </td>
      <td>8913</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">pulsar_uwsgi_socket</code></td>
      <td>If unset, uWSGI will be configured to listen for HTTP requests on pulsar_host port pulsar_port; If set, uWSGI will listen for uWSGI protocol connections on this socket.</td>
      <td><code class="highlighter-rouge">unset</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">pulsar_uwsgi_options</code></td>
      <td>Hash (dictionary) of additional uWSGI options to place in the [uwsgi] section of server.ini</td>
      <td><code class="highlighter-rouge">{}</code></td>
    </tr>
  </tbody>
</table>

<p>Some of the other options we will be using are:</p>

<ul>
  <li>We are going to run in RESTful mode so we will need to specify a <code class="highlighter-rouge">private_token</code> variable so we can “secure” the connection. (For a given value of “secure”.)</li>
  <li>We will be using the uwsgi web server to host the RESTful interface.</li>
  <li>We will set the tool dependencies to rely on <strong>conda</strong> for tool installs.</li>
</ul>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-configure-pulsar-group-variables"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Configure pulsar group variables</h3>

  <ol>
    <li>
      <p>Create a new file in <code class="highlighter-rouge">group_vars</code> called <code class="highlighter-rouge">pulsarservers.yml</code> and set some of the above variables as well as some others.</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">pulsar_server_dir</span><span class="pi">:</span> <span class="s">/mnt/pulsar/server</span>
<span class="na">pulsar_venv_dir</span><span class="pi">:</span> <span class="s">/mnt/pulsar/venv</span>
<span class="na">pulsar_config_dir</span><span class="pi">:</span> <span class="s">/mnt/pulsar/config</span>
<span class="na">pulsar_staging_dir</span><span class="pi">:</span> <span class="s">/mnt/pulsar/staging</span>
<span class="na">pulsar_pip_install</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">pulsar_host</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
<span class="na">pulsar_port</span><span class="pi">:</span> <span class="s">8913</span>

<span class="na">private_token</span><span class="pi">:</span> <span class="s1">'</span><span class="s">&lt;some_really_long_string_here&gt;'</span>

<span class="na">pulsar_optional_dependencies</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">pyOpenSSL</span>
  <span class="pi">-</span> <span class="s">psutil</span>
  <span class="pi">-</span> <span class="s">pycurl</span>
  <span class="pi">-</span> <span class="s">requests</span>
  <span class="pi">-</span> <span class="s">poster</span>

<span class="na">pulsar_yaml_config</span><span class="pi">:</span>
  <span class="na">dependency_resolvers_config_file</span><span class="pi">:</span> <span class="s">dependency_resolvers_conf.xml</span>
  <span class="na">conda_auto_init</span><span class="pi">:</span> <span class="s">True</span>
  <span class="na">conda_auto_install</span><span class="pi">:</span> <span class="s">True</span>
  <span class="na">staging_directory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">pulsar_staging_dir</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">private_token</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">private_token</span><span class="nv"> </span><span class="s">}}"</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Replace <code class="highlighter-rouge">&lt;some_really_long_string_here&gt;</code> with a long randomish (or not) string.</p>
    </li>
    <li>
      <p>Add the following lines to your <code class="highlighter-rouge">hosts</code> file:</p>

      <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[pulsarservers]</span>
<span class="err">&lt;ip_address</span> <span class="err">of</span> <span class="err">your</span> <span class="err">pulsar</span> <span class="err">server&gt;</span>
</code></pre></div>      </div>
    </li>
  </ol>
</blockquote>

<p>We will now write a new playbook for the pulsar installation similar to the one we did for the CVMFS installation earlier in the week.</p>

<p>We need to include a couple of pre-tasks to install python-virtualenv, python-pip and git etc.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-creating-the-playbook"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Creating the playbook</h3>

  <ol>
    <li>
      <p>Create a <code class="highlighter-rouge">pulsar_playbook.yml</code> file with the following contents:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">pulsarservers</span>
  <span class="na">pre_tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install some packages</span>
      <span class="na">apt</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">installed</span>
        <span class="na">update_cache</span><span class="pi">:</span> <span class="s">yes</span>
      <span class="na">become</span><span class="pi">:</span> <span class="s">yes</span>
      <span class="na">with_items</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">build-essential</span>
        <span class="pi">-</span> <span class="s">vim</span>
        <span class="pi">-</span> <span class="s">git</span>
        <span class="pi">-</span> <span class="s">python-dev</span>
        <span class="pi">-</span> <span class="s">libcurl4-openssl-dev</span>
        <span class="pi">-</span> <span class="s">libssl-dev</span>
        <span class="pi">-</span> <span class="s">virtualenv</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">chown the /mnt dir to ubuntu</span>
      <span class="na">file</span><span class="pi">:</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">/mnt</span>
        <span class="na">owner</span><span class="pi">:</span> <span class="s">ubuntu</span>
        <span class="na">group</span><span class="pi">:</span> <span class="s">ubuntu</span>
        <span class="na">mode</span><span class="pi">:</span> <span class="s">0755</span>
      <span class="na">become</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">galaxyproject.pulsar</span>
</code></pre></div>      </div>

      <p>There are a couple of <em>pre-tasks</em> here. This is because we need to install some base packages on these very vanilla ubuntu instances as well as give ourselves ownership of the directory we are installing into.</p>
    </li>
  </ol>

</blockquote>

<p>We also need to create the dependency resolver file so pulsar knows how to find and install dependencies for the tools we ask it to run. The simplest method which covers 99% of the use cases is to use conda auto installs similar to how Galaxy works. We need to create the file and put it where the <code class="highlighter-rouge">galaxyproject.pulsar</code> role can find it.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-creating-dependency-resolver-configuration"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Creating dependency resolver configuration</h3>

  <ol>
    <li>
      <p>Create a <code class="highlighter-rouge">templates</code> directory in your working directory.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>templates
</code></pre></div>      </div>
    </li>
    <li>
      <p>Create a <code class="highlighter-rouge">dependency_resolvers_conf.xml.j2</code> file inside the <code class="highlighter-rouge">templates</code> directory with the following contents:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency_resolvers&gt;</span>
    <span class="nt">&lt;conda</span> <span class="na">auto_install=</span><span class="s">"True"</span> <span class="na">auto_init=</span><span class="s">"True"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/dependency_resolvers&gt;</span>
</code></pre></div>      </div>

      <p>This tells pulsar to <strong>only</strong> look for dependencies in conda.</p>
    </li>
  </ol>

</blockquote>

<blockquote class="details">
  <h3 id="details-running-non-conda-tools"><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Running non-conda tools</h3>
  <p>If the tool you want to run on Pulsar doesn’t have a conda package, you will need to make alternative arrangements! This is complex and beyond our scope here. See the <a href="https://pulsar.readthedocs.io/en/latest/">Pulsar documentation</a> for details.</p>
</blockquote>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-run-the-playbook"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Run the Playbook</h3>

  <ol>
    <li>
      <p>Run the playbook. If your remote pulsar machine uses a different key, you may need to supply the <code class="highlighter-rouge">ansible-playbook</code> command with the private key for the connection using the <code class="highlighter-rouge">--private-key key.pem</code> option.</p>

      <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ansible-playbook <span class="nt">-i</span> hosts pulsar_playbook.yml
</code></pre></div>      </div>

      <p>After the script has run, pulsar will be installed on the remote machines!</p>
    </li>
    <li>
      <p>Log in to the machines and have a look in the <code class="highlighter-rouge">/mnt/pulsar</code> directory. You will see the venv and config directories. All the config files created can be perused.</p>
    </li>
  </ol>

</blockquote>

<p>Pulsar can now be started. We do that by first activating the virtualenv, then running it and telling it which webserver to use (Paster) and where the config files are.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-starting-pulsar"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Starting Pulsar</h3>

  <ol>
    <li>
      <p>Login to your Pulsar server</p>
    </li>
    <li>
      <p>Change directory into <code class="highlighter-rouge">/mnt/pulsar</code></p>
    </li>
    <li>
      <p>Activate the virtualenv (<code class="highlighter-rouge">source venv/bin/activate</code>)</p>
    </li>
    <li>
      <p>Run pulsar (<code class="highlighter-rouge">pulsar -m paster -c config/</code>)</p>
    </li>
  </ol>

</blockquote>

<p>A log will now start scrolling, showing the startup of pulsar. You’ll notice that it will be initializing and installing conda. Once it is complete and listening on the assigned port, you can stop the server with Ctrl-C.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-daemonizing"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Daemonizing</h3>

  <ol>
    <li>
      <p>This is a pretty gross way of running Pulsar and it can run in daemon mode. To do that, add <code class="highlighter-rouge">--daemon</code> to the end of the above command line.</p>
    </li>
    <li>
      <p>Stopping the daemon is as simple as re-running the command with <code class="highlighter-rouge">--stop-daemon</code> instead.</p>
    </li>
    <li>
      <p>Before proceeding, make sure your Pulsar is running in <code class="highlighter-rouge">--daemon</code> mode.</p>
    </li>
  </ol>

</blockquote>

<h1 id="configuring-galaxy">Configuring Galaxy</h1>

<p>Now we have a Pulsar server up and running, we need to tell our Galaxy about it.</p>

<p>Galaxy talks to the Pulsar server via it’s <code class="highlighter-rouge">job_conf.xml</code> file. We need to let Galaxy know about Pulsar there and make sure Galaxy has loaded the requisite job runner, and has a destination set up.</p>

<p>There are three things we need to do here:</p>

<ul>
  <li>We will need to create a job runner which uses the  <code class="highlighter-rouge">galaxy.jobs.runners.pulsar:PulsarRESTJobRunner</code> code.</li>
  <li>Create job destination which references the above job runner.</li>
  <li>Tell Galaxy which tools to send to the job destination.</li>
</ul>

<p>(We will use bwa-mem)</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-configure-galaxy"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Configure Galaxy</h3>

  <ol>
    <li>
      <p>In your <code class="highlighter-rouge">job_conf.xml</code> file add the following job runner to the <code class="highlighter-rouge">&lt;plugins&gt;</code> section:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin</span> <span class="na">id=</span><span class="s">"pulsar_runner"</span> <span class="na">type=</span><span class="s">"runner"</span> <span class="na">load=</span><span class="s">"galaxy.jobs.runners.pulsar:PulsarRESTJobRunner"</span> <span class="nt">/&gt;</span>
</code></pre></div>      </div>

      <p>Then add the Pulsar destination. We will need the ip address of your pulsar server and the private_token string you used when you created it.</p>

      <p>Add the following to the <code class="highlighter-rouge">&lt;destinations&gt;</code> section of your <code class="highlighter-rouge">job_conf.xml</code> file:</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;destination</span> <span class="na">id=</span><span class="s">"pulsar"</span> <span class="na">runner=</span><span class="s">"pulsar_runner"</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"url"</span><span class="nt">&gt;</span>http://your_ip_address_here:8913/<span class="nt">&lt;/param&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">id=</span><span class="s">"private_token"</span><span class="nt">&gt;</span>your_private_token_here<span class="nt">&lt;/param&gt;</span>
<span class="nt">&lt;/destination&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Finally we need to tell Galaxy which tools to send to Pulsar. We will tell it to send bwa-mem jobs to it. We use the <code class="highlighter-rouge">&lt;tools&gt;</code> section of the <code class="highlighter-rouge">job_conf.xml</code> file.
We need to know the full id of the tool in question, we can get this out of the <code class="highlighter-rouge">integrated_tool_panel.xml</code> file in the <code class="highlighter-rouge">mutable-config</code> directory. Then we tell Galaxy which destination to send it to (pulsar).</p>

      <p>Add the following to the end of the <code class="highlighter-rouge">job_conf.xml</code> file (inside the <code class="highlighter-rouge">&lt;tools&gt;</code> section if it exists or create it if it doesn’t.)</p>

      <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;tools&gt;</span>
    <span class="nt">&lt;tool</span> <span class="na">id=</span><span class="s">"toolshed.g2.bx.psu.edu/repos/devteam/bwa/bwa_mem/0.7.17.1"</span> <span class="na">destination=</span><span class="s">"pulsar"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/tools&gt;</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Restart Galaxy</p>
    </li>
  </ol>

</blockquote>

<h1 id="testing-pulsar">Testing Pulsar</h1>

<p>Now we will upload a small set of data to run bwa-mem with.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-testing-the-pulsar-destinatoin"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Testing the Pulsar destinatoin</h3>

  <ol>
    <li>
      <p>Upload the following files from zenodo.</p>

      <table>
        <thead>
          <tr>
            <th>File URL</th>
            <th>filetype</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code class="highlighter-rouge">https://zenodo.org/record/582600/files/mutant_R1.fastq</code></td>
            <td>fastqsanger</td>
          </tr>
          <tr>
            <td><code class="highlighter-rouge">https://zenodo.org/record/582600/files/mutant_R2.fastq</code></td>
            <td>fastqsanger</td>
          </tr>
          <tr>
            <td><code class="highlighter-rouge">https://zenodo.org/record/582600/files/wildtype.fna</code></td>
            <td>fasta</td>
          </tr>
        </tbody>
      </table>
    </li>
    <li>
      <p>Now run the bwa-mem tool with the <code class="highlighter-rouge">wildtype.fna</code> file as the reference, and the two fastq files as the paired end reads. Leave everything default.</p>

      <p>As soon as you press <em>execute</em> Galaxy will send the job to the pulsar server. You can watch the log in Galaxy using:</p>

      <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo supervisorctl tail -f galaxy stderr
</code></pre></div>      </div>

      <p>You can watch the log in Pulsar by ssh’ing to it and tailing the log file with:</p>

      <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tail -f /mnt/pulsar/paster.log
</code></pre></div>      </div>
    </li>
  </ol>

</blockquote>

<p>You’ll notice that the Pulsar server has received the job (all the way in Sydney!) and now should be installing bwa-mem via conda. Once this is complete (which may take a while - first time only) the job will run and the results will be returned to Galaxy!</p>

<p>How awesome is that? :)</p>



                    
                    <blockquote class="key_points">
                        <h3><i class="fa fa-key" aria-hidden="true"></i><span class="visually-hidden">keypoints</span> Key points</h3>

                        <ul>
                            
                            <li>Pulsar allows you to easily add geographically distributed compute resources into your Galaxy instance</li>
                            
                            <li>It also works well in situations where the compute resources cannot share storage pools.</li>
                            
                        </ul>
                    </blockquote>
                    

                    

                    

                </div>
            </div>
        </div>

        <h3><i class="fa fa-thumbs-up" aria-hidden="true"></i><span class="visually-hidden">congratulations</span> Congratulations on successfully completing this tutorial!</h3>

        

        

        <hr>
        <br>

        <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Running Jobs on Remote Resources with Pulsar (Galaxy Server administration)">Loading...
        </iframe>

        <blockquote class="feedback">
            <h3><i class="fa fa-comments-o" aria-hidden="true"></i><span class="visually-hidden">feedback</span> Give us even more feedback on this content!</h3>
            <p>To give us more detailed feedback about these materials, please take a moment to fill in the extended <a href="https://docs.google.com/forms/d/e/1FAIpQLSc_GLZRpxZGAL9tN6DA1bE6WkNhmQdXT7B16TpOb-X4YwKUsQ/viewform?entry.1548889262=Running Jobs on Remote Resources with Pulsar (Galaxy Server administration)">Feedback Form</a>.</p>
        </blockquote>
    </section>
</div>


<footer>
    <div class="container">
        <p>
            This material is the result of a collaborative work. Thanks to the
            <a href="https://wiki.galaxyproject.org/Teach/GTN">Galaxy Training Network</a>
            and all the <a href="/training-material/hall-of-fame">contributors</a> (Nate Coraor, Simon Gladman, Marius van den Beek, Helena Rasche)!
        </p>
        <p>
            Found a typo? Something is wrong in this tutorial? Edit it on
            <a href="https://github.com/galaxyproject/training-material/tree/master/topics/admin/tutorials/heterogeneous-compute/tutorial.md">GitHub</a>.
        </p>
    </div>
</footer>

    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>

    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
    var snippets=document.querySelectorAll('div.highlight');
    [].forEach.call(snippets,function(snippet){
        snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
    });

    var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.nextElementSibling;
    }});
    </script>
</html>
