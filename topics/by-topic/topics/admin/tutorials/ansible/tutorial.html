<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Ansible</title>
        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-45719423-18' , 'auto');
            ga('send', 'pageview');
        </script>
        
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap.min.css?v=3">
        <link rel="stylesheet" href="/training-material/assets/css/bootstrap-toc.min.css">
        <link rel="stylesheet" href="/training-material/assets/css/main.css?v=2">
        <link rel="stylesheet" href="/training-material/assets/css/font-awesome.css">
        <link rel="stylesheet" href="/training-material/assets/css/academicons.css">
        <link rel="stylesheet" href="/training-material/assets/css/syntax_highlighting.css">
        <link rel="shortcut icon" href="/training-material/favicon.ico" type="image/x-icon" />

        
        
        
        
        
        <meta name="description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:title" content="Galaxy Training: Ansible" />
        <meta property="og:description" content="Resources related to configuration and maintenance of Gal..." />
        <meta property="og:image" content="/training-material/assets/images/GTNLogo1000.png" />
    </head>
    <body data-spy="scroll" data-target="#toc">
        











<header>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/training-material/">
                <img src="/training-material/assets/images/GTN-60px.png" height="30" alt="Galaxy Training Network logo">
                Galaxy Training!
            </a>

            <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#top-navbar" aria-controls="top-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="top-navbar">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/training-material/topics/admin" title="Go back to list of tutorials">
                            <i class="fa fa-folder-o" aria-hidden="true"></i><span class="visually-hidden">topic</span> Galaxy Server administration
                        </a>
                    </li>

                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="EN">
                            EN
                        </a>
                        <div class="dropdown-menu">
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=fr&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fansible%2Ftutorial.html&edit-text=&act=url" title="">
                                FR
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ja&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fansible%2Ftutorial.html&edit-text=&act=url" title="">
                                JA
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=es&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fansible%2Ftutorial.html&edit-text=&act=url" title="">
                                ES
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=pt&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fansible%2Ftutorial.html&edit-text=&act=url" title="">
                                PT
                            </a>
                            
                            <a class="dropdown-item" href="https://translate.google.com/translate?hl=jp&sl=en&tl=ar&u=https%3A%2F%2Ftraining.galaxyproject.org%2Ftopics%2Fadmin%2Ftutorials%2Fansible%2Ftutorial.html&edit-text=&act=url" title="">
                                AR
                            </a>
                            
                        </div>
                    </li>

                    <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-expanded="false" title="Help">
        <i class="fa fa-life-ring" aria-hidden="true"></i><span class="visually-hidden">help</span> Help
    </a>
    <div class="dropdown-menu dropdown-menu-right">
        <form method="get" action="https://tess.elixir-europe.org/materials">
            <input type="text" id="search" name="q" value="" style="margin-left: 0.5em;/*! border-radius: 0px; */">
            <input type="hidden" value="Galaxy Training" name="content_provider">
            <input type="submit" value="Search on TeSS" style="width: 92%;border-radius: 0px;margin: 0.5em;background: #f47d20;border: 0px;padding: 0.25em;" class="">
        </form>

        <div class="dropdown-divider"></div>
        <a class="dropdown-item" href="/training-material/faq" title="Check our FAQ">
            FAQ
        </a>
        <a class="dropdown-item" href="https://gitter.im/Galaxy-Training-Network/Lobby" title="Chat on Gitter">
            Chat on Gitter
        </a>
        <a class="dropdown-item" href="https://help.galaxyproject.org/" title="Discuss on Galaxy Help">
            Discuss on Galaxy Help
        </a>
    </div>
</li>


                    <li class="nav-item">
                        <a class="nav-link" href="https://github.com/galaxyproject/training-material/edit/master/topics/admin/tutorials/ansible/tutorial.md">
                            <i class="fa fa-github" aria-hidden="true"></i><span class="visually-hidden">github</span> Edit
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<div class="container main-content">
    <script type="application/ld+json">
        


{
  "@context": "http://schema.org",
  "@type": "Course",
  "accessMode": [
    "textual",
    "visual"
  ],
  "accessModeSufficient": [
    "textual",
    "visual"
  ],
  "accessibilityControl": [
    "fullKeyboardControl",
    "fullMouseControl"
  ],
  "accessibilityFeature": [
    "alternativeText",
    "tableOfContents"
  ],
  "accessibilitySummary": "Short descriptions are present but long descriptions will be needed for non-visual users",
  "audience": {
    "@type": "EducationalAudience",
    "educationalRole": "students"
  },
  "citation": {
    "@type": "CreativeWork",
    "name": "Community-Driven Data Analysis Training for Biology",
    "url": "https://doi.org/10.1016/j.cels.2018.05.012"
  },
  "copyrightHolder": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "discussionUrl": "https://gitter.im/Galaxy-Training-Network/Lobby",
  "headline": "Ansible",
  "inLanguage": {
    "@type": "Language",
    "name": "English",
    "alternateName": "en"
  },
  "interactivityType": "mixed",
  "isAccessibleForFree": true,
  "license": "/blob//LICENSE.md",
  "producer": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "provider": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "sourceOrganization": {
    "@type": "Organization",
    "email": "galaxytrainingnetwork@gmail.com",
    "name": "Galaxy Training Network",
    "url": "https://galaxyproject.org/teach/gtn/"
  },
  "courseCode": "admin / ansible / hands-on",
  "learningResourceType": "hands-on tutorial",
  "name": "Hands-on for 'Ansible' tutorial",
  "isPartOf": {
    "@type": "Course",
    "name": "Ansible",
    "description": "Ansible",
    "learningResourceType": "tutorial",
    "interactivityType": "expositive",
    "provider": {
      "@type": "Organization",
      "email": "galaxytrainingnetwork@gmail.com",
      "name": "Galaxy Training Network",
      "url": "https://galaxyproject.org/teach/gtn/"
    }
  },
  "url": "https://galaxyproject.github.io//training-material/topics/admin/tutorials/ansible/tutorial.html",
  "timeRequired": "PT60M",
  "keywords": "ansible",
  "description": "Ansible\\nThe questions this  addresses are:\n - Why Ansible?\n - How and when to use Ansible?\n - How to write a role?\n - How to leverage community build roles?\n\n\\nThe objectives are:\n - Learn Ansible basics\n - Write a simple role\n - Install a role from Ansible Galaxy\n\n",
  "hasPart": [

  ],
  "mentions": [
    {
      "@type": "Thing",
      "url": "",
      "name": "Training data for Ansible tutorial"
    }
  ],
  "author": [
    {
      "@type": "Person",
      "name": "Helena Rasche"
    },
    {
      "@type": "Person",
      "name": "Saskia Hiltemann"
    }
  ],
  "contributor": [
    {
      "@type": "Person",
      "name": "Helena Rasche"
    },
    {
      "@type": "Person",
      "name": "Saskia Hiltemann"
    }
  ],
  "about": [
    {
      "@type": "CreativeWork",
      "name": "Galaxy Server administration",
      "description": "Resources related to configuration and maintenance of Galaxy servers",
      "url": "https://galaxyproject.github.io//training-material/topics/admin/"
    }
  ]
}
    </script>

    <section class="tutorial">
        <h1 data-toc-skip>Ansible</h1>
        <div class="contributors-line">By: 

<a href="/training-material/hall-of-fame#erasche" class="contributor-badge"><img src="https://avatars.githubusercontent.com/erasche" alt="Helena Rasche">Helena Rasche</a>, <a href="/training-material/hall-of-fame#shiltemann" class="contributor-badge"><img src="https://avatars.githubusercontent.com/shiltemann" alt="Saskia Hiltemann">Saskia Hiltemann</a>

</div>
        <blockquote class="overview">
            <h3>Overview</h3>
            <strong><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Questions</strong>
            <ul>
            
            <li>Why Ansible?</li>
            
            <li>How and when to use Ansible?</li>
            
            <li>How to write a role?</li>
            
            <li>How to leverage community build roles?</li>
            
            </ul>

            <strong><i class="fa fa-bullseye" aria-hidden="true"></i><span class="visually-hidden">objectives</span> Objectives</strong>
            <ul>
            
            <li>Learn Ansible basics</li>
            
            <li>Write a simple role</li>
            
            <li>Install a role from Ansible Galaxy</li>
            
            </ul>

            

            
            <p><strong><i class="fa fa-hourglass-end" aria-hidden="true"></i><span class="visually-hidden">time</span> Time estimation:</strong> 60 minutes</p>
            

            



            <div>
                <div><strong><i class="fa fa-external-link" aria-hidden="true"></i> Supporting Materials</strong></div>
                <div id="supporting_materials">
                    <ul>
                        <li>
                            <div>
                    
                    <div>
                        <a class="topic-icon" href="/training-material/topics/admin/tutorials/ansible/slides.html" title="Slides for this tutorial">
                            <i class="fa fa-slideshare" aria-hidden="true"></i><span class="visually-hidden">slides</span> Slides
                        </a>
                    </div>
                    

                    

                    
                    


                    
                    
                    <div>
                        

    <a href="#" class="btn btn-default dropdown-toggle topic-icon" data-toggle="dropdown" aria-expanded="false" title="Where to run the tutorial">
        <i class="fa fa-cog" aria-hidden="true"></i><span class="visually-hidden">instances</span> Galaxies
    </a>
    <ul class="dropdown-menu">
    
        <li>
            <a class="dropdown-item" href="https://github.com/galaxyproject/training-material/tree/master/topics/admin/docker" title="Docker image for this tutorial">
                <i class="fa fa-ship" aria-hidden="true"></i><span class="visually-hidden">docker_image</span> Docker image
            </a>
        </li>
    
    
    </ul>



                    </div>
                    
                    
                            </div>
                        </li>
                    </ul>
                </div>

            </div>

        </blockquote>

        <div class="container">
            <div class="row">
                <!-- sidebar, which will move to the top on a small screen -->
                <div class="col-sm-2">
                    <nav id="toc" data-toggle="toc" class="sticky-top"></nav>
                </div>
                <div class="col-sm-10">
                    <h1 class="no_toc" id="overview">Overview</h1>

<p>In this tutorial we have briefly cover what Ansible is and how to understand what it does. This guide is not meant to make you an expert on Ansible, but perhaps give you enough that you can debug broken roles and modify them to suit your needs. Or maybe to contribute to the <a href="https://github.com/galaxyproject?q=ansible">Galaxyproject Ansible roles</a>.</p>

<p>This will be a very practical training with emphasis on looking at examples from modules and becoming self sufficient.</p>

<blockquote class="agenda">
  <h3 id="agenda">Agenda</h3>

<ol id="markdown-toc">
  <li><a href="#what-is-ansible" id="markdown-toc-what-is-ansible">What is Ansible?</a>    <ol>
      <li><a href="#inventory-file" id="markdown-toc-inventory-file">Inventory file</a></li>
      <li><a href="#roles" id="markdown-toc-roles">Roles</a></li>
      <li><a href="#modules-and-tasks" id="markdown-toc-modules-and-tasks">Modules and Tasks</a></li>
      <li><a href="#playbooks" id="markdown-toc-playbooks">Playbooks</a></li>
      <li><a href="#variables" id="markdown-toc-variables">Variables</a></li>
      <li><a href="#vaults" id="markdown-toc-vaults">Vaults</a></li>
    </ol>
  </li>
  <li><a href="#your-first-playbook-and-first-role" id="markdown-toc-your-first-playbook-and-first-role">Your First Playbook and First Role</a>    <ol>
      <li><a href="#a-basic-role" id="markdown-toc-a-basic-role">A Basic Role</a></li>
      <li><a href="#facts" id="markdown-toc-facts">Facts</a></li>
      <li><a href="#templates" id="markdown-toc-templates">Templates</a></li>
    </ol>
  </li>
  <li><a href="#ansible-galaxy" id="markdown-toc-ansible-galaxy">Ansible Galaxy</a>    <ol>
      <li><a href="#choosing-a-role" id="markdown-toc-choosing-a-role">Choosing a Role</a></li>
    </ol>
  </li>
  <li><a href="#other-stuff" id="markdown-toc-other-stuff">Other Stuff</a>    <ol>
      <li><a href="#with-items" id="markdown-toc-with-items">With Items</a></li>
      <li><a href="#when-changed" id="markdown-toc-when-changed">When Changed</a></li>
      <li><a href="#notifying-handlers" id="markdown-toc-notifying-handlers">Notifying Handlers</a></li>
    </ol>
  </li>
</ol>

</blockquote>

<h1 id="what-is-ansible">What is Ansible?</h1>

<p>Ansible runs commands on local or remote computers. It can move files around, create files from templates, and run command line tools. Primarily used for system administration tasks at scale. It has a push model rather than a pull model like puppet. If you’ve used Puppet, Ansible doesn’t evaluate what changes need to be made and make those, it just runs through all of commands every time.</p>

<p>Some terms that you should know first:</p>

<dl>
  <dt>Inventory file</dt>
  <dd>An Ansible-specific file that defines the systems (“hosts”) and groups of hosts on which Ansible should operate.</dd>
  <dt>Ansible module</dt>
  <dd>A piece of Python code that converts some parameters into an invocation. An example would be the <code class="highlighter-rouge">command</code> module which converts parameters like <code class="highlighter-rouge">command: ls</code> into a command line that is executed. There are pre-built modules for just about everything.</dd>
  <dt>task</dt>
  <dd>A call to an Ansible module that should be executed and the configuration for this module.</dd>
  <dt>role</dt>
  <dd>A folder containing some tasks, templates, files, and default values for variables. People share roles on <a href="https://galaxy.ansible.com/">“Ansible Galaxy”</a>.</dd>
  <dt>playbook</dt>
  <dd>a YAML file listing a set of tasks and/or roles that should be applied to a group of hosts.</dd>
  <dt>vault</dt>
  <dd>An encrypted YAML file. You put your secrets here and then you can use them in tasks/roles/playbooks.</dd>
</dl>

<p>Looking at each of these briefly:</p>

<h2 id="inventory-file">Inventory file</h2>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[webservers]</span>
<span class="err">web_a</span>
<span class="err">web_b</span>

<span class="nn">[databases]</span>
<span class="err">db_1.example.org</span> <span class="py">ansible_user</span><span class="p">=</span><span class="s">root</span>
</code></pre></div></div>

<p>Here we’ve defined two groups of computers, <code class="highlighter-rouge">webservers</code> and <code class="highlighter-rouge">databases</code>. <code class="highlighter-rouge">ansible_user</code> is used to specify which user to connect with.</p>

<blockquote class="details">
  <h3 id="details-ansible-inventory-documentation"><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Ansible Inventory Documentation</h3>
  <p>For more advanced features of the inventory file, check out <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html">the official documentation on this topic</a>.</p>
</blockquote>

<h2 id="roles">Roles</h2>

<p>We will look at <a href="https://github.com/galaxyproject/ansible-cvmfs">ansible-cvmfs</a> as our example for the layout of a role:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── defaults
│   └── main.yml
├── files
│   ├── cvmfs_wipecache.c
│   ├── cvmfs_wipecache.centos_6
│   └── cvmfs_wipecache.centos_7
├── handlers
│   └── main.yml
├── meta
│   └── main.yml
├── tasks
│   └── main.yml
└── templates
    └── stratum1_squid.conf.j2
</code></pre></div></div>

<p>These are the folders that are included in many complex roles. Simpler roles will often not need all of the folders.</p>

<table>
  <thead>
    <tr>
      <th>Folder</th>
      <th>Usage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>defaults</td>
      <td>Default variables values go here (e.g. “version of software to install”).</td>
    </tr>
    <tr>
      <td>files</td>
      <td>These are files which should be copied as-is over to the remote location.</td>
    </tr>
    <tr>
      <td>handlers</td>
      <td>This is for restarting processes usually.</td>
    </tr>
    <tr>
      <td>meta</td>
      <td>Only needed if you publish your role to Ansible Galaxy.</td>
    </tr>
    <tr>
      <td>tasks</td>
      <td><strong>Always start reading here</strong>. This is the most important folder and the best place to start when trying to understand what an unfamiliar role does. Anything that is loaded will be referenced here, e.g. variables to load, handlers, files, templates.</td>
    </tr>
    <tr>
      <td>templates</td>
      <td>Files that are templated out with variables before being copied.</td>
    </tr>
  </tbody>
</table>

<blockquote class="details">
  <h3 id="details-ansible-role-documentation"><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Ansible Role Documentation</h3>

  <p>For more information check out <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse_roles.html">the official documentation on this topic</a>.</p>
</blockquote>

<h2 id="modules-and-tasks">Modules and Tasks</h2>

<p>A <code class="highlighter-rouge">tasks/main.yml</code> file calls multiple Ansible modules to accomplish its goal. A typical tasks file looks like:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install CernVM-FS client (yum)</span>
  <span class="na">yum</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">cvmfs</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">'latest'</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">cvmfs_upgrade_client</span><span class="nv"> </span><span class="s">else</span><span class="nv"> </span><span class="s">'present'</span><span class="nv"> </span><span class="s">}}"</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">ansible_os_family == "RedHat"</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ensure AutoFS is enabled + running</span>
  <span class="na">service</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">autofs</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">started</span>
</code></pre></div></div>

<p>Here we have two tasks. Each has a <code class="highlighter-rouge">name</code> that will be shown to the person running the playbook.</p>

<p>The first invokes the <code class="highlighter-rouge">yum</code> module with the arguments <code class="highlighter-rouge">name: cvmfs, state: ...</code>. This will use yum to install the package named <code class="highlighter-rouge">cvmfs</code>. The state parameter uses a <a href="http://jinja.pocoo.org/">Jinja2</a> template to evaluate the value of the variable <code class="highlighter-rouge">cvmfs_upgrade_client</code>. We can <a href="https://github.com/galaxyproject/ansible-cvmfs/search?q=cvmfs_upgrade_client&amp;unscoped_q=cvmfs_upgrade_client">grep through</a> the repository and see that <code class="highlighter-rouge">defaults/main.yml</code> sets that to <code class="highlighter-rouge">false</code> by default. We can override this if we need, we’ll come back to that later. The first task also has a <code class="highlighter-rouge">when</code> condition to ensure it only runs on RHEL family machines, so RedHat or CentOS. It is better to use the OS-generic <a href="http://docs.ansible.com/ansible/latest/package_module.html"><code class="highlighter-rouge">package</code></a> module, if possible.</p>

<p>The second invokes the <a href="http://docs.ansible.com/ansible/latest/service_module.html"><code class="highlighter-rouge">service</code></a> module. The arguments to this one are quite legible and the functionality can be inferred from the names for the most part: The service <code class="highlighter-rouge">name: autofs</code> will be <code class="highlighter-rouge">enabled</code> and its <code class="highlighter-rouge">state</code> should be <code class="highlighter-rouge">started</code>.</p>

<p><a href="https://docs.ansible.com/ansible/latest/modules/modules_by_category.html">Many modules</a> are available for you to use.</p>

<h3 id="stylistic-choices">Stylistic Choices</h3>

<p>Ansible accepts two ways to format tasks:</p>

<p>YAML style:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">package</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">package_name</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">package_state</span><span class="nv"> </span><span class="s">}}"</span>
</code></pre></div></div>

<p>And an inline style.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="s">package name={{ package_name }} state={{ package_state }}</span>
</code></pre></div></div>

<p>Some groups prefer one style or another. You can mix both of these but you probably shouldn’t. The inline style does not require quoting of templated values.</p>

<h2 id="playbooks">Playbooks</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CVMFS</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">webservers</span>
  <span class="na">vars</span><span class="pi">:</span>
    <span class="na">cvmfs_numfiles</span><span class="pi">:</span> <span class="s">4096</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">galaxyproject.cvmfs</span>
</code></pre></div></div>

<p>This is a quite minimal playbook. It selects a <code class="highlighter-rouge">hosts</code> group named <code class="highlighter-rouge">webservers</code>, overrides the variable <code class="highlighter-rouge">cvmfs_numfiles</code>, and then says the following set of roles will be executed for this group of hosts. Ansible makes it easy to collect tasks that should apply to a group of hosts and run a playbook for all of those hosts. Some good uses of this are things like ensuring a certain set of users are installed on all of your managed machines, or using one of the package autoupdating roles to make sure your machines are up-to-date.</p>

<blockquote class="details">
  <h3 id="details-ansible-playbook-documentation"><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Ansible Playbook Documentation</h3>

  <p>For more information check out <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_intro.html">the official documentation on this topic</a>.</p>
</blockquote>

<h3 id="philosophies">Philosophies</h3>

<p>Different groups use playbooks differently. Here is a non-exhaustive list of ways that the author has seen playbooks used:</p>

<table>
  <thead>
    <tr>
      <th>Strategy</th>
      <th>Use Cases</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>A single playbook that does everything</td>
      <td>Works well in cloud use cases where you would rather terminate a VM and just restart from nothing. If 100% of the tasks are idempotent (can be re-run without causing problems) then this can also work well for ensuring all machines that are managed are meeting your compliance standards.</td>
    </tr>
    <tr>
      <td>Playbooks that execute one-off commands</td>
      <td>Works well when you have commands that cannot safely be re-run (e.g. you are managing a repository on a remote machine and executing a ‘commit’ action.) Also works if you have multiple people who are responsible for managing a machine but you want to ensure exactly the same commands are run each time a task needs to be done, with no variation.</td>
    </tr>
  </tbody>
</table>

<h2 id="variables">Variables</h2>

<p>There are a bunch of places variables can be set. <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable">The list is ridiculous.</a> Try and find a convention within your group and stick to that to help manage the chaos.</p>

<p>There are some special places you can put variables that will be loaded automatically:</p>

<ul>
  <li><code class="highlighter-rouge">group_vars/&lt;group_name&gt;.yml</code>: if you run a playbook which has <code class="highlighter-rouge">hosts: webservers</code>, and <code class="highlighter-rouge">group_vars/webservers.yml</code> exists, it will be loaded.</li>
  <li><code class="highlighter-rouge">host_vars/&lt;host_name&gt;.yml</code>: if you run a playbook and it affects host (e.g.) <code class="highlighter-rouge">api01</code>, and <code class="highlighter-rouge">host_vars/api01.yml</code> exists, it will be loaded automatically.</li>
</ul>

<p>For a real-life example, UseGalaxy.eu <a href="https://github.com/usegalaxy-eu/infrastructure-playbook">generally attempts</a> to put variables in an appropriately named <code class="highlighter-rouge">group_vars/</code> file.</p>

<h2 id="vaults">Vaults</h2>

<p><a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html"><code class="highlighter-rouge">ansible-vault</code></a> is a super useful tool that lets you encrypt secrets for your group using a pre-shared key. This allows you to commit ALL of your Ansible playbooks and variables to source control, without the concern of leaking secrets. E.g. <a href="https://github.com/usegalaxy-eu/infrastructure-playbook/blob/master/secret_group_vars/all.yml">UseGalaxy.eu</a>’s vault file. The encrypted version is not very interesting to look at, but it is mostly to show that we confidently place an encrypted copy of our secrets online, under configuration management. This has made our life a lot easier.</p>

<h1 id="your-first-playbook-and-first-role">Your First Playbook and First Role</h1>

<p>The above introduction was certainly not enough for you to feel confident in Ansible, so we will now build a small role and a playbook to run this role.</p>

<blockquote class="warning">
  <h3 id="warning-safety-first"><i class="fa fa-warning" aria-hidden="true"></i><span class="visually-hidden">warning</span> Safety First</h3>

  <p>Many of the things you can do with Ansible can be quite dangerous. As dangerous as normally being at the Linux command line, but scaled across N machines. Be very careful with the changes you plan to make.
Ansible provides some flags which can help you identify changes before they’re made to production systems:</p>

  <dl>
    <dt><strong><code class="highlighter-rouge">--diff</code></strong></dt>
    <dd>This will show the difference whenever a file is changed.</dd>
    <dt><strong><code class="highlighter-rouge">--check</code></strong></dt>
    <dd>Will do a dry-run of the playbook, attempting to show you which tasks will execute, which files will be updated. Not all actions can be predicted because commands are not run, if a downstream task depends on the result of a command execution task, Ansible has no way of knowing whether or not it will execute.</dd>
  </dl>

  <p>In this tutorial we will write to files in <code class="highlighter-rouge">/tmp</code> as that is a <em>relatively</em> safe thing to do. The training material community does not have the resources to test this tutorial across all of the platforms you might want to run it on. Additionally we do not want to be responsible if you accidentally cause permanent damage by following this tutorial.</p>

</blockquote>

<h2 id="a-basic-role">A Basic Role</h2>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-setting-up-our-workspace"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Setting up our workspace</h3>

  <ol>
    <li>
      <p>Decide where you will install and run Ansible? On your laptop? Or on the remote machine/VM you will manage? All of the following steps should be done in the one location you pick.</p>
    </li>
    <li>
      <p><a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html">Install Ansible.</a></p>
    </li>
    <li>
      <p>Create an empty directory and <code class="highlighter-rouge">cd</code> into it</p>
    </li>
    <li>
      <p>Create your inventory file, name it <code class="highlighter-rouge">hosts</code>, in the folder you have just entered.</p>

      <ul>
        <li>
          <p>You are installing ansible on the machine it will be used to manage</p>

          <ol>
            <li>
              <p>Make sure you can SSH into it. Test it now.</p>
            </li>
            <li>
              <p>We will call our group <code class="highlighter-rouge">my_hosts</code></p>
            </li>
            <li>
              <p>Create a hosts file with the group <code class="highlighter-rouge">my_hosts</code> and your host.</p>

              <blockquote class="solution">
                <h3 id="solution-solution"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
                <p>The file should look like:</p>

                <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[my_hosts]</span>
<span class="err">your.host</span>
</code></pre></div>                </div>
                <p>Remember that if you SSH in with a username different than your current local user account’s name, you will need to specify <code class="highlighter-rouge">ansible_ssh_user=remote-user-name</code></p>
              </blockquote>
            </li>
          </ol>
        </li>
        <li>
          <p>You are installing ansible on a machine that will manage a second, remote machine</p>

          <ol>
            <li>
              <p>We will call our group <code class="highlighter-rouge">my_hosts</code></p>
            </li>
            <li>
              <p>Create a hosts file with the group <code class="highlighter-rouge">my_hosts</code> and <code class="highlighter-rouge">localhost ansible_connection=local</code>, which tells ansible to not use SSH, and just use the local connection.</p>

              <blockquote class="solution">
                <h3 id="solution-solution-1"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>
                <p>The file should look like:</p>

                <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[my_hosts]</span>
<span class="err">localhost</span> <span class="py">ansible_connection</span><span class="p">=</span><span class="s">local</span>
</code></pre></div>                </div>
              </blockquote>
            </li>
          </ol>
        </li>
      </ul>
    </li>
    <li>
      <p>Create the roles directory, your role, and the tasks folder: <code class="highlighter-rouge">mkdir -p roles/my-role/tasks/</code></p>
    </li>
    <li>
      <p>Create a YAML file in that directory, <code class="highlighter-rouge">roles/my-role/tasks/main.yml</code> and open it for editing</p>
    </li>
    <li>
      <p>Define a <code class="highlighter-rouge">copy</code> task like below:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Copy a file to the remote host</span>
  <span class="na">copy</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">test.txt</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s">/tmp/test.txt</span>
</code></pre></div>      </div>

      <p>You can read about all of the parameters available to the <a href="http://docs.ansible.com/ansible/latest/copy_module.html"><code class="highlighter-rouge">copy</code></a> module on Ansible’s documentation.</p>

      <blockquote class="details">
        <h3 id="details-ansible-module-documentation"><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Ansible Module Documentation</h3>
        <p>You can usually find a module that will represent most commands you will run at the linux cli. Usually by searching the internet for “ansible $do-some-action” e.g. “ansible copy file to server” or “ansible restart service.” If you cannot find a module that does it, there is the <a href="http://docs.ansible.com/ansible/latest/command_module.html"><code class="highlighter-rouge">command</code></a> module, but this should be avoided if possible. Expect to have a browser session with 10-30 different Ansible module documentation tabs if you work with Ansible regularly, no one remembers what arguments are available to every module.</p>

      </blockquote>
    </li>
    <li>
      <p>Create a <code class="highlighter-rouge">roles/my-role/files</code> folder, and within it a file named <code class="highlighter-rouge">test.txt</code>, containing the content “Hello, World”</p>
    </li>
    <li>
      <p>This is a complete role by itself and will copy the file <code class="highlighter-rouge">test.txt</code> from the <code class="highlighter-rouge">roles/my-role/files/</code> folder over to the remote server and place it in <code class="highlighter-rouge">/tmp</code>.</p>
    </li>
    <li>
      <p>Open <code class="highlighter-rouge">playbook.yml</code> for editing in the root folder. Place the following content in there:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="pi">-</span> <span class="na">hosts</span><span class="pi">:</span> <span class="s">my_hosts</span>
  <span class="na">roles</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">my-role</span>
</code></pre></div>      </div>

      <blockquote class="question">
        <h3 id="question-question"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>How does your file tree look now? Use <code class="highlighter-rouge">find</code> or <code class="highlighter-rouge">tree</code>.</p>

        <blockquote class="solution">
          <h3 id="solution-solution-2"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── hosts
├── playbook.yml
└── roles
    └── my-role
        ├── files
        │   └── test.txt
        └── tasks
            └── main.yml
</code></pre></div>          </div>

        </blockquote>
      </blockquote>
    </li>
    <li>
      <p>Run one of the following command, whichever is appropriate:</p>

      <ul>
        <li>Real remote host: <code class="highlighter-rouge">ansible-playbook -i hosts playbook.yml</code></li>
        <li>Localhost: <code class="highlighter-rouge">ansible-playbook -i hosts -c local playbook.yml</code></li>
      </ul>

      <p>Even local users can run the ‘real remote host’ command, Ansible will just issue a warning. Running with <code class="highlighter-rouge">-c local</code> silences this warning.</p>

      <blockquote class="question">
        <h3 id="question-question-1"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>How does the output look?</p>

        <blockquote class="solution">
          <h3 id="solution-solution-3"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <p>The important thing is <code class="highlighter-rouge">failed=0</code></p>

          <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ansible-playbook -i hosts playbook.yml -c local
PLAY [my_hosts] *********************************
TASK [Gathering Facts] *************************
ok: [localhost]
TASK [my-role : Copy] **************************
changed: [localhost]
PLAY RECAP *************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0
</code></pre></div>          </div>

          <p>You can re-run this and it should say <code class="highlighter-rouge">changed=0</code></p>
        </blockquote>
      </blockquote>
    </li>
    <li>
      <p>Login to the appropriate host and <code class="highlighter-rouge">cat /tmp/test.txt</code> to see that the change was made.</p>
    </li>
  </ol>

</blockquote>

<p>Now that you’ve done this, here are some starting points for exploration:</p>

<ul>
  <li>Add more hosts, watch as Ansible executes over all of them in parallel.</li>
  <li>Identify a task you do regularly, e.g. restarting a service. Find the Ansible service module and add that to your playbook.</li>
</ul>

<blockquote class="comment">
  <h3 id="comment-too-many-cows"><i class="fa fa-commenting-o" aria-hidden="true"></i><span class="visually-hidden">comment</span> Too Many Cows?</h3>
  <p>If you’ve installed the <code class="highlighter-rouge">cowsay</code> tool, Ansible (for some reason) will take advantage of that to output a lot of the output with cowsay. To disable this you can <code class="highlighter-rouge">export ANSIBLE_NOCOWS=1</code> (Remember that exporting will only last as long as the current invocation of your terminal does, so consider adding this to your user profile if you wish to keep cowsay installed and still have legible output.)</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ________________
&lt; PLAY [my_hosts] &gt;
 ----------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
 ________________________
&lt; TASK [Gathering Facts] &gt;
 ------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
</code></pre></div>  </div>
</blockquote>

<h2 id="facts">Facts</h2>

<p>In the last step of the last hands on, you ran your playbook. The first <code class="highlighter-rouge">TASK</code> that was executed was not one that you had written, it read:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TASK [Gathering Facts] *************************
ok: [localhost]
</code></pre></div></div>

<p>The <a href="https://docs.ansible.com/ansible/latest/modules/setup_module.html"><code class="highlighter-rouge">setup</code></a> module runs by default for every host and gathers facts about the host.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-the-setup-module"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: The Setup Module</h3>

  <ol>
    <li>
      <p>Run the command <code class="highlighter-rouge">ansible -i hosts -c local -m setup my_hosts</code>.</p>

      <p>The <code class="highlighter-rouge">my_hosts</code> at the end of the command refers to the group we defined in our <code class="highlighter-rouge">hosts</code> inventory file.</p>
    </li>
    <li>
      <p>Investigate the output. See what sort of information is made available to you.</p>

      <blockquote class="question">
        <h3 id="question-question-2"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <ol>
          <li>What variable stores the OS name?</li>
          <li>Where are all of the places that you can find your machine’s IP (v4) addresses?</li>
        </ol>

        <blockquote class="solution">
          <h3 id="solution-solution-4"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <ol>
            <li>
              <p>The OS name is stored in <code class="highlighter-rouge">ansible_distribution</code>. We saw <code class="highlighter-rouge">ansible_os_family</code> used above in the <code class="highlighter-rouge">ansible-cvmfs</code> role. You can use these variables if you are writing a generic role but packages or commands are named different on different operating systems.</p>
            </li>
            <li>
              <p>Ansible stores network information in quite a few places, sometimes one place is more convenient or more correct to use:</p>

              <ul>
                <li><code class="highlighter-rouge">ansible_all_ipv4_addresses</code></li>
                <li><code class="highlighter-rouge">ansible_default_ipv4</code></li>
                <li><code class="highlighter-rouge">ansible_&lt;interface_name&gt;.ipv4</code></li>
              </ul>
            </li>
          </ol>

        </blockquote>

      </blockquote>
    </li>
  </ol>

</blockquote>

<h2 id="templates">Templates</h2>

<p>Templates give you greater control over the files you are deploying to the remote system. If you need to deploy a file to multiple hosts, but configure it differently on each host, you should use templates. For instance deploying a service that should only listen on the correct IP address for that host would be a good use case for templates. All of the facts you discovered in the previous hands on are available to you to use in templates, <code class="highlighter-rouge">when</code> statements (like the <a href="#modules-and-tasks">ansible-cvmfs example we saw earlier</a>). Additionally all of the variables you’ve defined are available as well.</p>

<blockquote class="details">
  <h3 id="details-template-syntax"><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Template Syntax</h3>
  <p>Templates use Jinja2 syntax. If you are not familiar with it, you should <a href="http://jinja.pocoo.org/docs/2.10/templates/">read about it</a> first, before moving on with the tutorial.</p>
</blockquote>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-variables-and-templates"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Variables and Templates</h3>

  <ol>
    <li>
      <p>Create the directories: <code class="highlighter-rouge">roles/my-role/templates</code>, <code class="highlighter-rouge">roles/my-role/defaults</code></p>
    </li>
    <li>
      <p>Create and edit a file for your role’s variables, <code class="highlighter-rouge">roles/my-role/defaults/main.yml</code></p>
    </li>
    <li>
      <p>Insert the following content:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">my_role_key</span><span class="pi">:</span> <span class="s">deadbeefcafe</span>
</code></pre></div>      </div>

      <p>This will define a variable <code class="highlighter-rouge">my_role_key</code> that can then be used in templates.</p>
    </li>
    <li>
      <p>Create and edit <code class="highlighter-rouge">roles/my-role/templates/test.ini.j2</code></p>
    </li>
    <li>
      <p>Insert the following content:</p>

      <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[example]</span>
<span class="py">api_key</span> <span class="p">=</span> <span class="s">{{ my_role_key }}</span>
<span class="py">listen</span> <span class="p">=</span> <span class="s">{{ ansible_default_ipv4.address }}</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Edit <code class="highlighter-rouge">roles/my-role/tasks/main.yml</code> and append a new task to the end to template this file:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Template the configuration file</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">test.ini.j2</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s">/tmp/test.ini</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the playbook again.</p>
    </li>
    <li>
      <p>Login to the remote machine and check the contents of <code class="highlighter-rouge">/tmp/test.ini</code></p>

      <blockquote class="question">
        <h3 id="question-question-3"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>How does it look?</p>

        <blockquote class="solution">
          <h3 id="solution-solution-5"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <p>The file should look like:</p>

          <div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[example]</span>
<span class="py">api_key</span> <span class="p">=</span> <span class="s">deadbeefcafe</span>
<span class="py">listen</span> <span class="p">=</span> <span class="s">192.168.0.2</span>
</code></pre></div>          </div>

          <p>Where the last line has the machine’s IP address.</p>

        </blockquote>

      </blockquote>

      <p>Now that this has worked successfully, we will setup a <code class="highlighter-rouge">group_vars</code> folder
to show how a person using <code class="highlighter-rouge">my-role</code> would override the <code class="highlighter-rouge">my_role_key</code> variable.</p>
    </li>
    <li>
      <p>Create the folder <code class="highlighter-rouge">group_vars/</code> (in the root of your directory)</p>
    </li>
    <li>
      <p>Create and edit <code class="highlighter-rouge">group_vars/my_hosts.yml</code></p>
    </li>
    <li>
      <p>Insert the following:</p>

      <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">my_role_key</span><span class="pi">:</span> <span class="s">my_super_secret_api_key</span>
</code></pre></div>      </div>
    </li>
    <li>
      <p>Run the playbook again, but imagine you are worried about this change, and supply the <code class="highlighter-rouge">--check --diff</code> flag to see what changes are made before committing to make them.</p>

      <blockquote class="question">
        <h3 id="question-question-4"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>How does the output look?</p>

        <blockquote class="solution">
          <h3 id="solution-solution-6"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> ansible-playbook -i hosts playbook.yml -c local --check --diff
<span class="p">PLAY [my_hosts] ******************************************
TASK [Gathering Facts] **********************************
ok: [localhost]
TASK [my-role : Copy] ***********************************
ok: [localhost]
TASK [my-role : Template the configuration file] ********
</span><span class="gd">--- before: /tmp/test.ini
</span><span class="gi">+++ after: /home/hxr/.ansible/tmp/ansible-local-1906887dr2u6j8n/tmptx9pdelg/test.ini.j2
</span><span class="p">@@ -1,3 +1,3 @@</span>
 [example]
<span class="gd">-api_key = deadbeefcafe
</span><span class="gi">+api_key = my_super_secret_api_key
</span> listen = 192.168.0.25
<span class="p">changed: [localhost]
PLAY RECAP **********************************************
localhost                  : ok=3    changed=1    unreachable=0    failed=0
</span></code></pre></div>          </div>

          <p>Here you can see that the api_key value will be changed. Despite Ansible reporting <code class="highlighter-rouge">changed=1</code>, no changes have actually been applied to the system.</p>
        </blockquote>
      </blockquote>
    </li>
    <li>
      <p>Run the playbook again, without the <code class="highlighter-rouge">--check</code> flag to apply your changes.</p>
    </li>
  </ol>
</blockquote>

<h1 id="ansible-galaxy">Ansible Galaxy</h1>

<p>Now that you’ve built a small role, you can imagine that building real roles that manage the full installation of a piece of software are not simple things. Ansible Galaxy is the answer here. Many roles for common administration tasks, and software installation and setup are readily available on Ansible Galaxy.</p>

<p><strong>Warning</strong>: This will install git on the remote machine.</p>

<blockquote class="notranslate hands_on">
  <h3 id="hands_on-hands-on-installing-a-module-using-ansible-galaxy"><i class="fa fa-pencil" aria-hidden="true"></i><span class="visually-hidden">hands_on</span> Hands-on: Installing a module using ansible-galaxy</h3>

  <ol>
    <li>
      <p>Run the command <code class="highlighter-rouge">ansible-galaxy install -p roles/ geerlingguy.git</code></p>

      <p>This will install the new role into your <code class="highlighter-rouge">roles</code> folder, alongside your own role.</p>
    </li>
    <li>
      <p>Edit your playbook.yml and add the role at the bottom, after <code class="highlighter-rouge">my-role</code></p>
    </li>
    <li>
      <p>Run the playbook</p>

      <blockquote class="question">
        <h3 id="question-question-5"><i class="fa fa-question-circle" aria-hidden="true"></i><span class="visually-hidden">question</span> Question</h3>

        <p>Did something go wrong?</p>

        <blockquote class="solution">
          <h3 id="solution-solution-7"><i class="fa fa-eye" aria-hidden="true"></i><span class="visually-hidden">solution</span> Solution</h3>

          <p>Since you have been running the playbook as a non-root user (or at least you should have been!), the step to install a package fails.
The solution to this is to set <code class="highlighter-rouge">become: true</code>. Edit your playbook.yml and add <code class="highlighter-rouge">become: true</code> just below <code class="highlighter-rouge">hosts: my_hosts</code>.</p>

          <p><code class="highlighter-rouge">become</code> causes Ansible to attempt to become a different user (using sudo/su/whatever is appropriate), by default this is <code class="highlighter-rouge">root</code>. If you want to become a different user, just set <code class="highlighter-rouge">become_user</code>. Beware, the user should be able to privilege escalate without a password prompt. Otherwise when you execute the playbook you should set <code class="highlighter-rouge">--ask-become-pass</code>, using the privilege escalation password for that host.</p>

          <blockquote class="details">
            <h3 id="details-ansible-become"><i class="fa fa-info-circle" aria-hidden="true"></i><span class="visually-hidden">details</span> Ansible Become</h3>
            <p>See the <a href="https://docs.ansible.com/ansible/latest/user_guide/become.html">documentation</a> if you need to control this behaviour differently. <code class="highlighter-rouge">become</code> can be set either at the task level or the playbook level.</p>

          </blockquote>

        </blockquote>
      </blockquote>
    </li>
  </ol>

</blockquote>

<h2 id="choosing-a-role">Choosing a Role</h2>

<p>Picking the best role for a task from Ansible Galaxy is not always a trivial task. Sometimes there will only be a single role doing what you need. Other times you’ll have to choose between 20 different roles that all look more or less the same. Here are some tips to guide you in identifying appropriate and well-written roles:</p>

<ul>
  <li>The name should match the software you are using (I.e. ignore a role named <code class="highlighter-rouge">stackstorm</code> when you are trying to set up <code class="highlighter-rouge">rabbitmq</code>. Ansible Galaxy does not have perfect search.)</li>
  <li><code class="highlighter-rouge">geerlingguy</code> wrote a huge number of roles for many pieces of standard software. If there is a role from this person, this is usually a safe choice.</li>
  <li>Check the GitHub readme of each role you consider using. Look for:
    <ul>
      <li>Extensive documentation of all of the variables, their default values, and how they behave.</li>
      <li>An example playbook using the role</li>
    </ul>
  </li>
  <li>A large number of downloads is a good sign that other people found it useful</li>
</ul>

<p>These are usually good proxies for quality, but do not treat them as strict rules. For an example of a role meeting many of these qualities, <a href="https://github.com/galaxyproject/ansible-cvmfs"><code class="highlighter-rouge">ansible-cvmfs</code></a> is good; the variables are well documented and there are example playbooks that you can (more or less) copy-and-paste and run.</p>

<p>Sometimes a role will accomplish 95% of what you need to do, but not everything. Once you have installed the role with <code class="highlighter-rouge">ansible-galaxy install</code>, you can edit it locally to make any changes. In an ideal world you would contribute this back, but this is not always a high priority. Many projects copy roles directly into their repositories, e.g. <a href="https://github.com/galaxyproject/infrastructure-playbook/tree/master/roles">galaxyproject</a> and <a href="https://github.com/usegalaxy-eu/infrastructure-playbook/tree/master/roles">usegalaxy.eu</a></p>

<h1 id="other-stuff">Other Stuff</h1>

<p>Ansible has a huge array of features and we can’t cover them all. Some commonly used features are documented below:</p>

<h2 id="with-items">With Items</h2>

<p>Duplicating tasks ten times to install ten packages is not efficient, so Ansible provides <code class="highlighter-rouge">with_items</code> construct</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install stuff</span>
  <span class="na">package</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">installed</span>
  <span class="na">with_items</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">htop</span>
    <span class="pi">-</span> <span class="s">git</span>
    <span class="pi">-</span> <span class="s">vim</span>
</code></pre></div></div>

<p>This works for any task, not just package installation if you have things you’d like to repeat.</p>

<h2 id="when-changed">When Changed</h2>

<p>Doing something only when a task is in the “changed” state is a common pattern. This is often used for reloading a service when some configuration files have changed.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Copy configuration file</span>
  <span class="na">copy</span><span class="pi">:</span>
    <span class="na">src</span><span class="pi">:</span> <span class="s">main.conf</span>
    <span class="na">dest</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/etc/service/main.conf</span>
    <span class="s">owner:</span><span class="nv"> </span><span class="s">"root"</span>
    <span class="na">group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">root"</span>
    <span class="na">mode</span><span class="pi">:</span> <span class="s2">"</span><span class="s">0644"</span>
  <span class="na">register</span><span class="pi">:</span> <span class="s">service_conf</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Restart the service</span>
  <span class="na">service</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">service</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">restarted</span>
  <span class="na">when</span><span class="pi">:</span> <span class="s">service_conf.changed</span>
</code></pre></div></div>

<h2 id="notifying-handlers">Notifying Handlers</h2>

<p>Often you want to restart a service whenever something has changed, like above. But if you need to restart the service whenever one of many different tasks has changed, there is a simpler way than writing <code class="highlighter-rouge">when: a.changed or b.changed or c.changed or ...</code></p>

<p>First, move the restarting or reloading of the service into the <code class="highlighter-rouge">handlers/main.yml</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- name: restart service
  service:
    name: service
    enabled: yes
    state: restarted

- name: reload httpd
  service:
    name: httpd
    enabled: yes
    state: reloaded
</code></pre></div></div>

<p>Now you can change your task definitions:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- name: Copy configuration file
  copy:
    src: main.conf
    dest: "/etc/service/main.conf
    owner: "root"
    group: "root"
    mode: "0644"
  notify: 'restart service'
</code></pre></div></div>

<p>We no longer <code class="highlighter-rouge">register</code> the command, instead the <code class="highlighter-rouge">notify</code> attribute automatically marks that the appropriate handler should be called <em>at the end of the playbook run</em>. Additionally tasks from outside of this role can use the same <code class="highlighter-rouge">notify</code>. So if you use a community built role for managing apache, and then have a custom role that builds the apache configuration, you can use changes there to reload the service using their definition of the reload/restart.</p>



                    
                    <blockquote class="key_points">
                        <h3><i class="fa fa-key" aria-hidden="true"></i><span class="visually-hidden">keypoints</span> Key points</h3>

                        <ul>
                            
                            <li>Ansible lets you do system administration at scale</li>
                            
                            <li>Many system administration, software installation, and software management tasks are already available as ansible tasks or roles</li>
                            
                        </ul>
                    </blockquote>
                    

                    

                    

                </div>
            </div>
        </div>

        <h3><i class="fa fa-thumbs-up" aria-hidden="true"></i><span class="visually-hidden">congratulations</span> Congratulations on successfully completing this tutorial!</h3>

        

        

        <hr>
        <br>

        <iframe id="feedback-google" class="google-form" src="https://docs.google.com/forms/d/e/1FAIpQLSd4VZptFTQ03kHkMz0JyW9b6_S8geU5KjNE_tLM0dixT3ZQmA/viewform?embedded=true&entry.1235803833=Ansible (Galaxy Server administration)">Loading...
        </iframe>

        <blockquote class="feedback">
            <h3><i class="fa fa-comments-o" aria-hidden="true"></i><span class="visually-hidden">feedback</span> Give us even more feedback on this content!</h3>
            <p>To give us more detailed feedback about these materials, please take a moment to fill in the extended <a href="https://docs.google.com/forms/d/e/1FAIpQLSc_GLZRpxZGAL9tN6DA1bE6WkNhmQdXT7B16TpOb-X4YwKUsQ/viewform?entry.1548889262=Ansible (Galaxy Server administration)">Feedback Form</a>.</p>
        </blockquote>
    </section>
</div>


<footer>
    <div class="container">
        <p>
            This material is the result of a collaborative work. Thanks to the
            <a href="https://wiki.galaxyproject.org/Teach/GTN">Galaxy Training Network</a>
            and all the <a href="/training-material/hall-of-fame">contributors</a> (Helena Rasche, Saskia Hiltemann)!
        </p>
        <p>
            Found a typo? Something is wrong in this tutorial? Edit it on
            <a href="https://github.com/galaxyproject/training-material/tree/master/topics/admin/tutorials/ansible/tutorial.md">GitHub</a>.
        </p>
    </div>
</footer>

    </body>
    <script type="text/javascript" src="/training-material/assets/js/jquery.slim.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/popper.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap.min.js?v=3"></script>
    <script type="text/javascript" src="/training-material/assets/js/details-element-polyfill.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="/training-material/assets/js/bootstrap-toc.min.js"></script>
    <script type="text/javascript" src="/training-material/assets/js/main.js"></script>

    <script type="text/javascript" src="/training-material/assets/js/clipboard.min.js"></script>
    <script type="text/javascript">
    var snippets=document.querySelectorAll('div.highlight');
    [].forEach.call(snippets,function(snippet){
        snippet.firstChild.insertAdjacentHTML('beforebegin','<button class="btn btn-light" data-clipboard-snippet><i class="fa fa-copy"></i>&nbsp;Copy</button>');
    });

    var clipboardSnippets=new ClipboardJS('[data-clipboard-snippet]',{
        target:function(trigger){return trigger.nextElementSibling;
    }});
    </script>
</html>
